<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tales of Eden</title>

  <link rel="stylesheet" href="styles.css" />
  <script src="theme-loader.js"></script>
</head>
<body class="home-body">
  <div class="home-shell">
    <!-- TOP BAR -->
    <header class="home-topbar">
      <div class="home-top-left">
        <div class="home-logo-dot"></div>
        <div class="home-title">Tales of Eden</div>
      </div>
      <nav class="home-nav">
        <a href="index.html" class="home-nav-link active">Home</a>
        <a href="library.html" class="home-nav-link">Library</a>
        <a href="codex.html" class="home-nav-link">Codex</a>
        <!-- You can later point this to a dedicated customization page -->
        <a href="library.html#customize" class="home-nav-link">Customize</a>
      </nav>
    </header>

    <!-- MAIN / HERO -->
    <main class="home-main">
      <div class="home-hero">
        <h1>World Archive</h1>
        <p>
          Read the stories in the Library, and use the Codex to look up characters, locations and anomalies
          from the Eden setting.
        </p>

        <div class="home-hero-buttons">
          <a href="library.html" class="btn-pill primary">Open Library</a>
          <a href="codex.html" class="btn-pill">Open Codex</a>
          <a href="library.html#customize" class="btn-pill subtle">Customize appearance</a>
        </div>

        <div class="home-continue" id="appContinue">
          Loading reading progress…
        </div>
      </div>
    </main>

    <!-- FOOTER -->
    <footer class="home-footer">
      Progress is stored locally in your browser.
    </footer>
  </div>

  <script>
    (function () {
      const BOOKS_JSON = "books.json";
      const continueEl = document.getElementById("appContinue");
      let booksIndex = {};

      function loadBooks() {
        return fetch(BOOKS_JSON)
          .then(r => r.json())
          .then(data => {
            (data || []).forEach(b => {
              if (!b || !b.id) return;
              booksIndex[b.id] = b;
            });
          })
          .catch(() => { /* fail silently */ });
      }

      function readProgress() {
        const out = [];
        const now = Date.now();
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (!key || !key.startsWith("toe_progress_")) continue;
          try {
            const raw = localStorage.getItem(key);
            if (!raw) continue;
            const data = JSON.parse(raw);
            const bookId = key.replace("toe_progress_", "");
            if (!bookId || typeof data.lastPage !== "number") continue;
            out.push({
              bookId,
              lastPage: data.lastPage,
              total: data.totalPages || 0,
              updatedAt: data.updatedAt || now
            });
          } catch { /* ignore broken entries */ }
        }
        out.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
        return out;
      }

      function buildReaderUrl(book, page) {
        if (!book || !book.path) return null;
        const base = book.path.replace(/index\.html$/i, "reader.html");
        return base + "?p=" + page;
      }

      function renderContinue() {
        const sessions = readProgress();
        if (!sessions.length) {
          continueEl.textContent =
            "No active reading yet. Open a book from the Library to start.";
          return;
        }

        const s = sessions[0];
        const book = booksIndex[s.bookId] || {};
        const title = book.title || s.bookId;
        const url = buildReaderUrl(book, s.lastPage) || "library.html";

        continueEl.innerHTML =
          `Continue reading <a href="${url}">${title}</a> · page ${s.lastPage}` +
          (s.total ? ` of ${s.total}.` : ".");
      }

      loadBooks().finally(renderContinue);
    })();
  </script>
</body>
</html>
