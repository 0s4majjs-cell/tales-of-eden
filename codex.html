<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tales of Eden â€“ Codex</title>

  <link rel="stylesheet" href="styles.css" />
  <script src="theme-loader.js"></script>

  <style>
    :root {
      --codex-radius-lg: 24px;
      --codex-radius-md: 16px;
      --codex-radius-pill: 999px;
      --codex-border-subtle: 1px solid rgba(255, 255, 255, 0.12);
      --codex-glass-bg: linear-gradient(
        135deg,
        rgba(3, 7, 18, 0.94),
        rgba(15, 23, 42, 0.94)
      );
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-ui, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif);
      color: var(--color-text-main, #e9f1ff);
      background:
        radial-gradient(circle at top, #1b2640 0, #050814 60%),
        #050814;
      background-attachment: fixed;
      display: flex;
      flex-direction: column;
    }

    .codex-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 24px clamp(16px, 4vw, 40px);
      gap: 18px;
    }

    /* Top bar */

    .codex-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .codex-logo-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .codex-logo-mark {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 20%, #38bdf8 0, #6366f1 22%, #020617 70%);
      box-shadow: 0 0 30px rgba(129, 140, 248, 0.5);
      position: relative;
      overflow: hidden;
    }

    .codex-logo-mark::after {
      content: "";
      position: absolute;
      inset: 12%;
      border-radius: 10px;
      border: 1px solid rgba(15, 23, 42, 0.8);
    }

    .codex-logo-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .codex-logo-title {
      font-size: 15px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(226, 232, 255, 0.96);
    }

    .codex-logo-sub {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
    }

    /* Top nav pill group */

    .codex-top-nav {
      display: flex;
      align-items: center;
      gap: 2px;
      padding: 2px;
      border-radius: var(--codex-radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 0.9)
      );
      box-shadow:
        0 18px 40px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .codex-nav-link {
      border-radius: var(--codex-radius-pill);
      padding: 4px 12px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border: none;
      background: transparent;
      color: rgba(148, 163, 184, 0.9);
      text-decoration: none;
      cursor: pointer;
      opacity: 0.9;
      transition:
        background 0.15s ease,
        color 0.15s ease,
        transform 0.1s ease,
        box-shadow 0.15s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    .codex-nav-link:not(.is-disabled):hover {
      background: rgba(30, 64, 175, 0.95);
      color: rgba(226, 232, 255, 0.98);
      box-shadow: 0 0 0 1px rgba(191, 219, 254, 0.6);
      transform: translateY(-1px);
    }

    .codex-nav-link.is-active {
      background: radial-gradient(circle at top, #4f46e5 0, #1d4ed8 45%, #020617 110%);
      color: rgba(226, 232, 255, 0.98);
      box-shadow: 0 0 0 1px rgba(191, 219, 254, 0.85);
    }

    .codex-nav-link.is-disabled {
      opacity: 0.4;
      cursor: default;
      pointer-events: none;
    }

    @media (max-width: 780px) {
      .codex-topbar {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    /* Main layout */

    .codex-main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 2.2fr);
      gap: 18px;
      margin-top: 6px;
    }

    @media (max-width: 900px) {
      .codex-main {
        grid-template-columns: minmax(0, 1fr);
        grid-template-rows: auto auto;
      }
    }

    /* Left: Nav */

    .codex-nav {
      border-radius: var(--codex-radius-lg);
      border: var(--codex-border-subtle);
      background: var(--codex-glass-bg);
      box-shadow:
        0 20px 70px rgba(15, 23, 42, 0.98),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      padding: 14px 14px 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }

    .codex-nav-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
    }

    .codex-nav-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: rgba(226, 232, 255, 0.96);
    }

    .codex-nav-count {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.9);
    }

    .codex-search-wrap {
      margin-top: 4px;
    }

    .codex-search-field {
      position: relative;
    }

    .codex-search-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.98);
      padding: 7px 11px;
      padding-right: 26px;
      color: rgba(226, 232, 255, 0.98);
      font-size: 12px;
      outline: none;
    }

    .codex-search-input::placeholder {
      color: rgba(100, 116, 139, 0.9);
    }

    .codex-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .codex-cat-pill {
      padding: 3px 9px;
      border-radius: var(--codex-radius-pill);
      border: 1px solid rgba(51, 65, 85, 0.95);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(148, 163, 184, 0.96);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        color 0.15s ease,
        transform 0.1s ease,
        box-shadow 0.15s ease;
    }

    .codex-cat-pill .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
    }

    .codex-cat-pill.active {
      border-color: rgba(59, 130, 246, 0.9);
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.45), rgba(15, 23, 42, 0.98));
      color: rgba(226, 232, 255, 0.98);
      box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.7);
    }

    .codex-cat-pill.active .dot {
      background: rgba(248, 250, 252, 0.95);
    }

    .codex-entry-list-wrap {
      flex: 1;
      min-height: 0;
      margin-top: 6px;
      border-radius: var(--codex-radius-md);
      border: 1px solid rgba(30, 64, 175, 0.7);
      background: radial-gradient(circle at top, rgba(30, 64, 175, 0.18), rgba(15, 23, 42, 0.98));
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .codex-entry-list {
      list-style: none;
      margin: 0;
      padding: 4px;
      overflow-y: auto;
      flex: 1;
      scrollbar-width: thin;
      scrollbar-color: rgba(51, 65, 85, 0.85) transparent;
    }

    .codex-entry-list::-webkit-scrollbar {
      width: 6px;
    }

    .codex-entry-list::-webkit-scrollbar-thumb {
      background: rgba(51, 65, 85, 0.9);
      border-radius: 999px;
    }

    .codex-entry-item {
      border-radius: 10px;
      padding: 6px 7px;
      border: 1px solid transparent;
      margin-bottom: 3px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
      transition:
        background 0.12s ease,
        border-color 0.12s ease,
        transform 0.08s ease;
    }

    .codex-entry-item:last-child {
      margin-bottom: 0;
    }

    .codex-entry-item:hover {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(51, 65, 85, 1);
      transform: translateY(-0.5px);
    }

    .codex-entry-item.active {
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.35), rgba(15, 23, 42, 0.98));
      border-color: rgba(96, 165, 250, 0.9);
      box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.55);
    }

    .codex-entry-item-id {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.96);
    }

    .codex-entry-item-title {
      font-size: 13px;
      color: rgba(226, 232, 255, 0.98);
    }

    .codex-entry-item-meta {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.9);
    }

    .codex-entry-empty {
      padding: 8px 10px;
      font-size: 12px;
      color: rgba(148, 163, 184, 0.9);
      border-top: 1px solid rgba(30, 64, 175, 0.7);
    }

    /* Right panel */

    .codex-entry-panel {
      border-radius: var(--codex-radius-lg);
      border: var(--codex-border-subtle);
      background: var(--codex-glass-bg);
      box-shadow:
        0 20px 70px rgba(15, 23, 42, 0.98),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      padding: 14px 14px 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .codex-entry-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }

    .codex-entry-id {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
      margin-bottom: 2px;
    }

    .codex-entry-main-title {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(226, 232, 255, 0.98);
    }

    .codex-entry-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
    }

    .codex-chip {
      padding: 3px 9px;
      border-radius: var(--codex-radius-pill);
      border: 1px solid rgba(51, 65, 85, 0.95);
      background: rgba(15, 23, 42, 0.96);
      font-size: 11px;
      color: rgba(148, 163, 184, 0.96);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .codex-chip strong {
      font-weight: 500;
      color: rgba(226, 232, 255, 0.98);
    }

    .codex-entry-top-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
      flex-shrink: 0;
    }

    .codex-entry-open-book {
      padding: 5px 10px;
      border-radius: var(--codex-radius-pill);
      border: 1px solid rgba(96, 165, 250, 0.9);
      background: rgba(15, 23, 42, 0.98);
      color: rgba(226, 232, 255, 0.98);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      text-decoration: none;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        transform 0.1s ease,
        box-shadow 0.15s ease;
      white-space: nowrap;
    }

    .codex-entry-open-book:hover {
      background: rgba(37, 99, 235, 0.96);
      border-color: rgba(191, 219, 254, 1);
      box-shadow: 0 0 0 1px rgba(191, 219, 254, 0.6);
      transform: translateY(-1px);
    }

    .codex-entry-open-book span.icon {
      font-size: 13px;
      opacity: 0.9;
    }

    .codex-entry-meta-line {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.9);
      text-align: right;
    }

    /* Appears in */

    .codex-appears {
      border-radius: var(--codex-radius-md);
      border: 1px solid rgba(30, 64, 175, 0.8);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.35), rgba(15, 23, 42, 0.98));
      padding: 8px 10px;
      margin-bottom: 4px;
    }

    .codex-appears-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: rgba(191, 219, 254, 0.96);
      margin-bottom: 4px;
    }

    .codex-appears-books {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .codex-appears-chip {
      padding: 3px 9px;
      border-radius: var(--codex-radius-pill);
      border: 1px solid rgba(191, 219, 254, 0.8);
      background: rgba(15, 23, 42, 0.98);
      color: rgba(226, 232, 255, 0.98);
      font-size: 11px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        transform 0.1s ease,
        box-shadow 0.15s ease;
      white-space: nowrap;
    }

    .codex-appears-chip:hover {
      background: rgba(37, 99, 235, 0.96);
      border-color: rgba(191, 219, 254, 1);
      box-shadow: 0 0 0 1px rgba(191, 219, 254, 0.6);
      transform: translateY(-1px);
    }

    .codex-appears-chip span.tagline {
      font-size: 10px;
      color: rgba(191, 219, 254, 0.9);
    }

    /* Body */

    .codex-entry-body-wrap {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: thin;
      scrollbar-color: rgba(51, 65, 85, 0.85) transparent;
    }

    .codex-entry-body-wrap::-webkit-scrollbar {
      width: 6px;
    }

    .codex-entry-body-wrap::-webkit-scrollbar-thumb {
      background: rgba(51, 65, 85, 0.9);
      border-radius: 999px;
    }

    .codex-entry-summary {
      font-size: 13px;
      color: rgba(191, 219, 254, 0.95);
      margin-bottom: 8px;
    }

    .codex-entry-body {
      font-size: 13px;
      line-height: 1.6;
      color: rgba(226, 232, 255, 0.96);
    }

    .codex-entry-body p {
      margin: 0 0 8px;
    }

    .codex-entry-body h3 {
      margin: 12px 0 4px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: rgba(191, 219, 254, 0.96);
    }

    .codex-entry-body ul {
      margin: 4px 0 8px 18px;
      padding: 0;
      font-size: 13px;
    }

    .codex-entry-body li {
      margin-bottom: 3px;
    }

    .codex-entry-empty-state {
      font-size: 13px;
      color: rgba(148, 163, 184, 0.9);
      margin-top: 6px;
    }

    /* Footer */

    .codex-footer {
      margin-top: 4px;
      padding: 4px 2px 0;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: rgba(148, 163, 184, 0.8);
      gap: 8px;
      border-top: 1px solid rgba(15, 23, 42, 0.9);
    }

    .codex-footer-links {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .codex-footer-links a {
      color: rgba(148, 163, 184, 0.9);
      text-decoration: none;
      border-bottom: 1px dotted rgba(55, 65, 81, 0.7);
    }

    .codex-footer-links a:hover {
      color: rgba(226, 232, 255, 0.98);
      border-bottom-color: rgba(156, 163, 175, 0.9);
    }

    @media (max-width: 700px) {
      .codex-entry-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .codex-entry-top-actions {
        align-items: flex-start;
      }
      .codex-shell {
        padding-inline: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="codex-shell">
    <!-- TOP BAR -->
    <header class="codex-topbar">
      <div class="codex-logo-group">
        <div class="codex-logo-mark"></div>
        <div class="codex-logo-text">
          <div class="codex-logo-title">Tales of Eden</div>
          <div class="codex-logo-sub">Codex / World Archive</div>
        </div>
      </div>

      <nav class="codex-top-nav">
        <a href="library.html" class="codex-nav-link">Library</a>
        <a href="codex.html" class="codex-nav-link is-active">Codex</a>
<a href="settings.html" class="codex-nav-link">Settings</a>
      </nav>
    </header>

    <!-- MAIN -->
    <main class="codex-main">
      <!-- LEFT: NAVIGATION -->
      <aside class="codex-nav">
        <div class="codex-nav-header">
          <div class="codex-nav-title">Codex Index</div>
          <div class="codex-nav-count" id="codexCount">â€“ entries</div>
        </div>

        <div class="codex-search-wrap">
          <div class="codex-search-field">
            <input
              id="codexSearchInput"
              class="codex-search-input"
              type="search"
              placeholder="Search by name, id, or summaryâ€¦"
              autocomplete="off"
            />
          </div>
        </div>

        <div class="codex-categories" id="codexCategories"></div>

        <div class="codex-entry-list-wrap">
          <ul class="codex-entry-list" id="codexEntryList">
            <!-- populated by JS -->
          </ul>
          <div class="codex-entry-empty" id="codexEntryEmpty" style="display: none;">
            No entries match this view.
          </div>
        </div>
      </aside>

      <!-- RIGHT: ENTRY VIEW -->
      <section class="codex-entry-panel">
        <header class="codex-entry-header">
          <div>
            <div class="codex-entry-id" id="codexEntryId">â€“</div>
            <h1 class="codex-entry-main-title" id="codexEntryTitle">Select a codex entry</h1>
            <div class="codex-entry-chips" id="codexEntryChips"></div>
          </div>

          <div class="codex-entry-top-actions">
            <a id="codexOpenBookBtn" href="library.html" class="codex-entry-open-book" style="display:none;">
              <span class="icon">ðŸ“–</span>
              <span>Open related book</span>
            </a>
            <div class="codex-entry-meta-line" id="codexEntryMetaLine">
              â€“
            </div>
          </div>
        </header>

        <div id="codexAppearsSection" class="codex-appears" style="display:none;">
          <div class="codex-appears-title">Appears In</div>
          <div class="codex-appears-books" id="codexAppearsBooks"></div>
        </div>

        <div class="codex-entry-body-wrap">
          <p class="codex-entry-summary" id="codexEntrySummary">
            Use the index on the left to select an entry.
          </p>
          <div class="codex-entry-body" id="codexEntryBody"></div>

          <div class="codex-entry-empty-state" id="codexEntryEmptyState" style="display:none;">
            No additional body content available for this entry.
          </div>
        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer class="codex-footer">
      <span>Tales of Eden â€“ Codex</span>
      <div class="codex-footer-links">
        <a href="index.html">Hub</a>
        <a href="library.html">Library</a>
      </div>
    </footer>
  </div>

  <script>
    (function () {
      const CODEX_JSON = "Codex/codex.json";
      const BOOKS_JSON = "books.json";

      const countEl = document.getElementById("codexCount");
      const catContainer = document.getElementById("codexCategories");
      const searchInput = document.getElementById("codexSearchInput");
      const listEl = document.getElementById("codexEntryList");
      const listEmptyEl = document.getElementById("codexEntryEmpty");

      const entryIdEl = document.getElementById("codexEntryId");
      const entryTitleEl = document.getElementById("codexEntryTitle");
      const entryChipsEl = document.getElementById("codexEntryChips");
      const entrySummaryEl = document.getElementById("codexEntrySummary");
      const entryBodyEl = document.getElementById("codexEntryBody");
      const entryEmptyStateEl = document.getElementById("codexEntryEmptyState");
      const entryMetaLineEl = document.getElementById("codexEntryMetaLine");
      const openBookBtn = document.getElementById("codexOpenBookBtn");

      const appearsSectionEl = document.getElementById("codexAppearsSection");
      const appearsBooksEl = document.getElementById("codexAppearsBooks");

      let entries = [];
      let booksIndex = {};
      let categorySet = new Set();
      let activeCategory = "All";
      let activeEntryId = null;

      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          id: params.get("id") || null,
          q: params.get("q") || "",
          category: params.get("category") || null
        };
      }

      function updateUrl(id, category, q) {
        const params = new URLSearchParams();
        if (id) params.set("id", id);
        if (category && category !== "All") params.set("category", category);
        if (q && q.trim()) params.set("q", q.trim());
        const newUrl = window.location.pathname + "?" + params.toString();
        window.history.replaceState(null, "", newUrl);
      }

      function simpleSearchScore(entry, query) {
        if (!query) return 0;
        const q = query.toLowerCase();
        let score = 0;
        if (entry.title && entry.title.toLowerCase().includes(q)) score += 3;
        if (entry.id && entry.id.toLowerCase().includes(q)) score += 2;
        if (entry.category && entry.category.toLowerCase().includes(q)) score += 1;
        if (entry.summary && entry.summary.toLowerCase().includes(q)) score += 1;
        return score;
      }

      function normalizeBody(entry) {
        if (!entry) return [];
        if (Array.isArray(entry.body)) return entry.body;
        if (typeof entry.body === "string") return [entry.body];
        return [];
      }

      function parseBulletSections(bodyArray) {
        const blocks = [];
        let currentLines = [];
        let currentTitle = null;

        function flushBlock() {
          if (!currentLines.length && !currentTitle) return;
          const text = currentLines.join("\n").trim();
          if (!text) return;
          blocks.push({
            title: currentTitle,
            text
          });
          currentLines = [];
          currentTitle = null;
        }

        (bodyArray || []).forEach(line => {
          if (typeof line !== "string") return;
          const trimmed = line.trim();
          if (!trimmed) {
            currentLines.push("");
            return;
          }
          // "## Section"
          if (/^#{2,}\s+/.test(trimmed)) {
            flushBlock();
            currentTitle = trimmed.replace(/^#{2,}\s+/, "").trim();
          } else {
            currentLines.push(line);
          }
        });

        flushBlock();
        return blocks;
      }

      function formatInline(text) {
        if (!text) return "";
        return text
          .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
          .replace(/_(.+?)_/g, "<em>$1</em>");
      }

      function buildBodyHtml(entry) {
        const rawBody = normalizeBody(entry);
        const blocks = parseBulletSections(rawBody);
        if (!blocks.length) return "";

        const htmlParts = [];

        blocks.forEach(block => {
          const text = block.text || "";
          if (block.title) {
            htmlParts.push("<h3>" + formatInline(block.title) + "</h3>");
          }

          const lines = text.split("\n");
          let bulletBuf = [];

          function flushBullets() {
            if (!bulletBuf.length) return;
            htmlParts.push("<ul>");
            bulletBuf.forEach(line => {
              htmlParts.push("<li>" + formatInline(line.replace(/^[-*]\s*/, "")) + "</li>");
            });
            htmlParts.push("</ul>");
            bulletBuf = [];
          }

          lines.forEach(line => {
            const trimmed = line.trim();
            if (!trimmed) {
              flushBullets();
              htmlParts.push("<p>&nbsp;</p>");
            } else if (/^[-*]\s+/.test(trimmed)) {
              bulletBuf.push(trimmed);
            } else {
              flushBullets();
              htmlParts.push("<p>" + formatInline(trimmed) + "</p>");
            }
          });

          flushBullets();
        });

        return htmlParts.join("");
      }

      function buildCategorySet() {
        categorySet = new Set(["All"]);
        entries.forEach(e => {
          if (e.category) categorySet.add(e.category);
        });
      }

      function renderCategories() {
        if (!catContainer) return;
        catContainer.innerHTML = "";

        const categories = Array.from(categorySet);
        categories.sort((a, b) => {
          if (a === "All") return -1;
          if (b === "All") return 1;
          return a.localeCompare(b);
        });

        categories.forEach(cat => {
          const pill = document.createElement("button");
          pill.type = "button";
          pill.className = "codex-cat-pill" + (cat === activeCategory ? " active" : "");
          pill.innerHTML = `<span class="dot"></span><span>${cat}</span>`;
          pill.addEventListener("click", () => {
            activeCategory = cat;
            updateUrl(activeEntryId, activeCategory, searchInput.value || "");
            renderCategories();
            renderEntryList();
          });
          catContainer.appendChild(pill);
        });
      }

      function filteredEntries() {
        const query = (searchInput.value || "").trim();
        const q = query.toLowerCase();
        const cat = activeCategory;

        const scored = entries
          .map(e => {
            let include = true;
            if (cat && cat !== "All" && e.category !== cat) include = false;
            let score = 0;
            if (q) {
              const s = simpleSearchScore(e, q);
              if (s <= 0) include = false;
              score = s;
            }
            return { entry: e, include, score };
          })
          .filter(x => x.include);

        if (q) {
          scored.sort((a, b) => {
            if (b.score !== a.score) return b.score - a.score;
            return (a.entry.title || a.entry.id || "").localeCompare(
              b.entry.title || b.entry.id || ""
            );
          });
        } else {
          scored.sort((a, b) => {
            const ca = a.entry.category || "";
            const cb = b.entry.category || "";
            if (ca !== cb) return ca.localeCompare(cb);
            return (a.entry.title || a.entry.id || "").localeCompare(
              b.entry.title || b.entry.id || ""
            );
          });
        }

        return scored.map(x => x.entry);
      }

      function renderEntryList() {
        if (!listEl || !listEmptyEl) return;

        const subset = filteredEntries();
        listEl.innerHTML = "";

        if (!subset.length) {
          listEmptyEl.style.display = "";
          return;
        }
        listEmptyEl.style.display = "none";

        subset.forEach(entry => {
          const li = document.createElement("li");
          li.className = "codex-entry-item" + (entry.id === activeEntryId ? " active" : "");
          li.dataset.id = entry.id || "";

          const idDiv = document.createElement("div");
          idDiv.className = "codex-entry-item-id";
          idDiv.textContent = entry.id || "â€”";

          const titleDiv = document.createElement("div");
          titleDiv.className = "codex-entry-item-title";
          titleDiv.textContent = entry.title || entry.id || "Untitled";

          const metaDiv = document.createElement("div");
          metaDiv.className = "codex-entry-item-meta";
          const cat = entry.category || "Uncategorized";
          const type = entry.type || "";
          metaDiv.textContent = type ? `${cat} Â· ${type}` : cat;

          li.appendChild(idDiv);
          li.appendChild(titleDiv);
          li.appendChild(metaDiv);

          li.addEventListener("click", () => {
            activeEntryId = entry.id || null;
            updateUrl(activeEntryId, activeCategory, searchInput.value || "");
            renderEntryList();
            renderEntryDetail();
          });

          listEl.appendChild(li);
        });
      }

      function dedupeAppearsIn(arr) {
        if (!Array.isArray(arr)) return [];
        const map = new Map();
        arr.forEach(item => {
          if (!item || !item.bookId) return;
          const key = item.bookId;
          const page = item.page || item.pages;
          if (!map.has(key)) {
            map.set(key, { bookId: item.bookId, pages: [] });
          }
          const rec = map.get(key);
          if (Array.isArray(page)) {
            page.forEach(p => {
              const n = Number(p);
              if (!Number.isFinite(n)) return;
              if (!rec.pages.includes(n)) rec.pages.push(n);
            });
          } else if (page != null) {
            const n = Number(page);
            if (Number.isFinite(n) && !rec.pages.includes(n)) rec.pages.push(n);
          }
        });
        const out = Array.from(map.values());
        out.forEach(o => {
          o.pages = Array.from(new Set(o.pages.map(x => String(x))));
        });
        return out;
      }

      function buildReaderUrlForBookId(bookId, firstPage) {
        const book = booksIndex[bookId] || null;
        if (!book) return null;
        const path = book.path || "";
        if (!path) return null;
        const base = path.replace(/index\.html$/i, "reader.html");
        if (!firstPage) return base;
        return base + "?p=" + encodeURIComponent(firstPage);
      }

      function pickPrimaryBookForEntry(entry) {
        if (!entry || !entry.appearsIn || !entry.appearsIn.length) return null;
        const deduped = dedupeAppearsIn(entry.appearsIn);
        return deduped[0] || null;
      }

      function renderAppearsIn(entry) {
        if (!appearsSectionEl || !appearsBooksEl) return;
        appearsBooksEl.innerHTML = "";

        if (!entry || !entry.appearsIn || !entry.appearsIn.length) {
          appearsSectionEl.style.display = "none";
          return;
        }

        const deduped = dedupeAppearsIn(entry.appearsIn);
        if (!deduped.length) {
          appearsSectionEl.style.display = "none";
          return;
        }

        deduped.forEach(item => {
          const bookId = item.bookId;
          const book = booksIndex[bookId] || null;
          const label = (book && book.title) || bookId;
          const firstPage = item.pages && item.pages.length ? item.pages[0] : null;

          const a = document.createElement("a");
          a.className = "codex-appears-chip";
          const url = buildReaderUrlForBookId(bookId, firstPage);
          a.href = url || "library.html";
          a.target = "_blank";

          const mainSpan = document.createElement("span");
          mainSpan.textContent = label;
          a.appendChild(mainSpan);

          if (item.pages && item.pages.length) {
            const tagSpan = document.createElement("span");
            tagSpan.className = "tagline";
            if (item.pages.length === 1) {
              tagSpan.textContent = "page " + item.pages[0];
            } else {
              tagSpan.textContent = "pages " + item.pages[0] + "â€¦";
            }
            a.appendChild(tagSpan);
          }

          appearsBooksEl.appendChild(a);
        });

        appearsSectionEl.style.display = "";
      }

      function renderEntryDetail() {
        const entry = entries.find(e => e.id === activeEntryId) || null;

        if (!entry) {
          entryIdEl.textContent = "â€“";
          entryTitleEl.textContent = "No entry selected";
          entryChipsEl.innerHTML = "";
          entrySummaryEl.textContent = "Use the index on the left to choose an entry.";
          entryBodyEl.innerHTML = "";
          entryEmptyStateEl.style.display = "none";
          entryMetaLineEl.textContent = "0 entries loaded";
          openBookBtn.style.display = "none";
          appearsSectionEl.style.display = "none";
          return;
        }

        entryIdEl.textContent = entry.id || "â€“";
        entryTitleEl.textContent = entry.title || entry.id || "Untitled";

        entryChipsEl.innerHTML = "";
        if (entry.category) {
          const catChip = document.createElement("div");
          catChip.className = "codex-chip";
          catChip.innerHTML = `<strong>Category</strong><span>${entry.category}</span>`;
          entryChipsEl.appendChild(catChip);
        }
        if (entry.type) {
          const typeChip = document.createElement("div");
          typeChip.className = "codex-chip";
          typeChip.innerHTML = `<strong>Type</strong><span>${entry.type}</span>`;
          entryChipsEl.appendChild(typeChip);
        }
        if (entry.status) {
          const statusChip = document.createElement("div");
          statusChip.className = "codex-chip";
          statusChip.innerHTML = `<strong>Status</strong><span>${entry.status}</span>`;
          entryChipsEl.appendChild(statusChip);
        }

        if (entry.summary) {
          entrySummaryEl.textContent = entry.summary;
        } else {
          entrySummaryEl.textContent = "";
        }

        const bodyHtml = buildBodyHtml(entry);
        entryBodyEl.innerHTML = bodyHtml;

        if (!bodyHtml && !entry.summary) {
          entryEmptyStateEl.style.display = "";
        } else {
          entryEmptyStateEl.style.display = "none";
        }

        const catText = entry.category || "Uncategorized";
        const appearsCount = Array.isArray(entry.appearsIn) ? dedupeAppearsIn(entry.appearsIn).length : 0;
        const appearsText = appearsCount
          ? `Appears in ${appearsCount} work${appearsCount > 1 ? "s" : ""}`
          : "No linked works";
        entryMetaLineEl.textContent = `${catText} Â· ${appearsText}`;

        renderAppearsIn(entry);

        const mainAppear = pickPrimaryBookForEntry(entry);
        if (mainAppear) {
          const url = buildReaderUrlForBookId(
            mainAppear.bookId,
            mainAppear.pages && mainAppear.pages[0]
          );
          if (url) {
            openBookBtn.href = url;
            openBookBtn.style.display = "";
          } else {
            openBookBtn.style.display = "none";
          }
        } else {
          openBookBtn.style.display = "none";
        }
      }

      function attachEvents() {
        if (!searchInput) return;
        let searchDebounce = null;

        searchInput.addEventListener("input", () => {
          if (searchDebounce) clearTimeout(searchDebounce);
          searchDebounce = setTimeout(() => {
            updateUrl(activeEntryId, activeCategory, searchInput.value || "");
            renderEntryList();
          }, 130);
        });
      }

      function fetchBooks() {
        return fetch(BOOKS_JSON)
          .then(r => r.json())
          .then(data => {
            booksIndex = {};
            (data || []).forEach(b => {
              if (!b || !b.id) return;
              booksIndex[b.id] = b;
            });
          })
          .catch(err => {
            console.warn("[codex] Failed to load books.json:", err);
          });
      }

      function fetchCodex() {
        return fetch(CODEX_JSON)
          .then(r => r.json())
          .then(data => {
            entries = Array.isArray(data) ? data : [];
            if (countEl) {
              countEl.textContent = entries.length + " entries";
            }
          })
          .catch(err => {
            console.error("[codex] Failed to load Codex:", err);
            entries = [];
            if (countEl) countEl.textContent = "0 entries";
          });
      }

      function boot() {
        const qp = getQueryParams();
        activeCategory = qp.category || "All";

        fetchBooks()
          .then(fetchCodex)
          .then(() => {
            buildCategorySet();
            renderCategories();

            if (searchInput && qp.q) {
              searchInput.value = qp.q;
            }

            if (qp.id && entries.some(e => e.id === qp.id)) {
              activeEntryId = qp.id;
            } else {
              const subset = filteredEntries();
              activeEntryId = subset.length
                ? subset[0].id
                : (entries[0] && entries[0].id) || null;
            }

            renderEntryList();
            renderEntryDetail();
            attachEvents();
          });
      }

      boot();
    })();
  </script>
</body>
</html>
