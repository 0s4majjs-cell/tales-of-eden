<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tales of Eden â€“ Codex</title>

  <link rel="stylesheet" href="styles.css" />
  <script src="theme-loader.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-ui, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif);
      color: var(--color-text-main, #e5e7eb);
      background:
        radial-gradient(circle at top, var(--color-bg-main-top, #111827) 0, var(--color-bg-main-bottom, #020617) 60%),
        #020617;
      background-attachment: fixed;
      display: flex;
      flex-direction: column;
    }

    .cx-shell {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 12px clamp(16px, 4vw, 40px);
    }

    /* TOP BAR */

    .cx-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
    }

    .cx-top-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cx-logo-dot {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fbbf24 0, #f97316 30%, #111827 85%);
    }

    .cx-title-main {
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-size: 12px;
    }

    .cx-nav {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .cx-nav a {
      text-decoration: none;
      color: #e5e7eb;
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      opacity: 0.9;
    }

    .cx-nav a:hover {
      border-color: rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.8);
    }

    .cx-nav a.active {
      border-color: rgba(96, 165, 250, 0.9);
      background: rgba(15, 23, 42, 0.9);
    }

    /* LAYOUT */

    .cx-main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(220px, 320px) minmax(0, 1fr);
      gap: 14px;
      padding-top: 10px;
      min-height: 0;
    }

    @media (max-width: 900px) {
      .cx-main {
        grid-template-columns: minmax(0, 1fr);
        grid-auto-rows: minmax(0, auto);
      }
    }

    /* LEFT PANEL */

    .cx-left {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .cx-left-head h1 {
      margin: 0;
      font-size: 16px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }

    .cx-left-head p {
      margin: 0;
      font-size: 12px;
      color: #9ca3af;
    }

    .cx-filters {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
    }

    .cx-search-wrap {
      position: relative;
    }

    .cx-search {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(17, 24, 39, 0.96);
      color: #e5e7eb;
      font-size: 12px;
      padding: 6px 10px 6px 26px;
      outline: none;
    }

    .cx-search::placeholder {
      color: #9ca3af;
    }

    .cx-search-wrap::before {
      content: "ðŸ”Ž";
      position: absolute;
      left: 7px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
    }

    .cx-cat-row {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .cx-select {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(17, 24, 39, 0.96);
      color: #e5e7eb;
      font-size: 11px;
      padding: 6px 10px;
      outline: none;
      cursor: pointer;
    }

    .cx-count {
      font-size: 11px;
      color: #9ca3af;
    }

    .cx-list-wrap {
      flex: 1;
      border-radius: 6px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.9);
      overflow-y: auto;
      min-height: 0;
    }

    .cx-list {
      list-style: none;
      margin: 0;
      padding: 4px 0;
      font-size: 12px;
    }

    .cx-list-empty {
      padding: 6px 10px;
      font-size: 12px;
      color: #9ca3af;
    }

    .cx-item-btn {
      width: 100%;
      padding: 4px 10px;
      border: none;
      background: transparent;
      color: #e5e7eb;
      text-align: left;
      display: block;
      cursor: pointer;
    }

    .cx-item-btn:hover {
      background: rgba(30, 64, 175, 0.25);
    }

    .cx-item-btn.active {
      background: rgba(15, 23, 42, 1);
    }

    .cx-item-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cx-item-meta {
      font-size: 11px;
      color: #9ca3af;
    }

    /* RIGHT PANEL */

    .cx-right {
      display: flex;
      flex-direction: column;
      min-height: 0;
      border-radius: 6px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.9);
      padding: 10px 12px;
      font-size: 13px;
    }

    .cx-entry-id {
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .cx-entry-title {
      font-size: 18px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin: 2px 0 0;
    }

    .cx-entry-tags {
      font-size: 11px;
      color: #cbd5f5;
      margin-top: 4px;
    }

    .cx-entry-summary {
      font-size: 12px;
      color: #cbd5f5;
      margin-top: 4px;
    }

    .cx-entry-meta {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .cx-open-book {
      margin-top: 6px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(59, 130, 246, 0.9);
      background: rgba(15, 23, 42, 1);
      color: #e5e7eb;
      text-decoration: none;
    }

    .cx-body-wrap {
      flex: 1;
      margin-top: 8px;
      overflow-y: auto;
    }

    .cx-body-wrap::-webkit-scrollbar {
      width: 6px;
    }

    .cx-body-wrap::-webkit-scrollbar-thumb {
      background: rgba(55, 65, 81, 0.9);
      border-radius: 999px;
    }

    .cx-body {
      line-height: 1.6;
    }

    .cx-body h3 {
      margin: 12px 0 4px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #bfdbfe;
    }

    .cx-body p {
      margin: 0 0 8px;
    }

    .cx-body ul {
      margin: 4px 0 8px 18px;
      padding: 0;
    }

    .cx-body-empty {
      font-size: 12px;
      color: #9ca3af;
    }

    .cx-appears {
      margin-top: 8px;
      font-size: 11px;
      color: #bfdbfe;
    }

    .cx-appears-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .cx-appears-link {
      border-radius: 999px;
      border: 1px solid rgba(59, 130, 246, 0.9);
      padding: 3px 7px;
      color: #e5e7eb;
      text-decoration: none;
      font-size: 11px;
    }

    /* FOOTER */

    .cx-footer {
      font-size: 11px;
      color: #6b7280;
      padding-top: 6px;
      border-top: 1px solid rgba(15, 23, 42, 0.9);
      text-align: left;
    }

    .cx-footer a {
      color: inherit;
      text-decoration: none;
      border-bottom: 1px dotted rgba(75, 85, 99, 0.9);
    }
  </style>
</head>
<body>
  <div class="cx-shell">
    <header class="cx-topbar">
      <div class="cx-top-left">
        <div class="cx-logo-dot"></div>
        <div class="cx-title-main">Tales of Eden â€“ Codex</div>
      </div>
      <nav class="cx-nav">
        <a href="index.html">Home</a>
        <a href="library.html">Library</a>
        <a href="codex.html" class="active">Codex</a>
      </nav>
    </header>

    <main class="cx-main">
      <!-- LEFT: list -->
      <aside class="cx-left">
        <div class="cx-left-head">
          <h1>Codex</h1>
          <p>Reference entries for locations, anomalies, people and organisations.</p>
        </div>

        <div class="cx-filters">
          <div class="cx-search-wrap">
            <input id="cxSearch" class="cx-search" type="search"
                   placeholder="Search by title, id, summaryâ€¦" />
          </div>
          <div class="cx-cat-row">
            <select id="cxCategory" class="cx-select">
              <option value="All">All categories</option>
            </select>
            <span class="cx-count" id="cxCount">Loadingâ€¦</span>
          </div>
        </div>

        <div class="cx-list-wrap">
          <ul id="cxList" class="cx-list"></ul>
          <div id="cxListEmpty" class="cx-list-empty" style="display:none;">
            No entries match this view.
          </div>
        </div>
      </aside>

      <!-- RIGHT: entry -->
      <section class="cx-right">
        <div class="cx-entry-id" id="cxEntryId">â€“</div>
        <div class="cx-entry-title" id="cxEntryTitle">Select a codex entry</div>
        <div class="cx-entry-tags" id="cxEntryTags"></div>
        <div class="cx-entry-summary" id="cxEntrySummary">
          Use the list on the left to choose an entry.
        </div>
        <div class="cx-entry-meta" id="cxEntryMeta">â€“</div>

        <a id="cxOpenBook" href="#" class="cx-open-book" style="display:none;">Open related book</a>

        <div class="cx-appears" id="cxAppears" style="display:none;">
          Appears in:
          <div class="cx-appears-list" id="cxAppearsList"></div>
        </div>

        <div class="cx-body-wrap">
          <div class="cx-body" id="cxBody"></div>
          <div class="cx-body-empty" id="cxBodyEmpty" style="display:none;">
            No additional body content for this entry.
          </div>
        </div>
      </section>
    </main>

    <footer class="cx-footer">
      <span>Codex entries are in <code>Codex/codex.json</code>. Linked books come from <code>books.json</code>.</span>
    </footer>
  </div>

  <script>
    (function () {
      const CODEX_JSON = "Codex/codex.json";
      const BOOKS_JSON = "books.json";

      const searchInput   = document.getElementById("cxSearch");
      const categorySel   = document.getElementById("cxCategory");
      const countEl       = document.getElementById("cxCount");
      const listEl        = document.getElementById("cxList");
      const listEmptyEl   = document.getElementById("cxListEmpty");

      const entryIdEl     = document.getElementById("cxEntryId");
      const entryTitleEl  = document.getElementById("cxEntryTitle");
      const entryTagsEl   = document.getElementById("cxEntryTags");
      const entrySummaryEl= document.getElementById("cxEntrySummary");
      const entryMetaEl   = document.getElementById("cxEntryMeta");
      const bodyEl        = document.getElementById("cxBody");
      const bodyEmptyEl   = document.getElementById("cxBodyEmpty");
      const openBookEl    = document.getElementById("cxOpenBook");
      const appearsWrapEl = document.getElementById("cxAppears");
      const appearsListEl = document.getElementById("cxAppearsList");

      let entries    = [];
      let booksIndex = {};
      let activeId   = null;

      function qp() {
        const p = new URLSearchParams(window.location.search);
        return {
          id: p.get("id") || null,
          q: p.get("q") || "",
          category: p.get("category") || "All"
        };
      }

      function updateURL(id, category, q) {
        const params = new URLSearchParams();
        if (id) params.set("id", id);
        if (category && category !== "All") params.set("category", category);
        if (q && q.trim()) params.set("q", q.trim());
        const s = params.toString();
        history.replaceState(null, "", window.location.pathname + (s ? "?" + s : ""));
      }

      function simpleScore(entry, query) {
        if (!query) return 0;
        const q = query.toLowerCase();
        let score = 0;
        if (entry.title && entry.title.toLowerCase().includes(q)) score += 3;
        if (entry.id && entry.id.toLowerCase().includes(q)) score += 2;
        if (entry.summary && entry.summary.toLowerCase().includes(q)) score += 1;
        return score;
      }

      function normBody(entry) {
        if (!entry) return [];
        if (Array.isArray(entry.body)) return entry.body;
        if (typeof entry.body === "string" && entry.body.trim()) return [entry.body];
        return [];
      }

      function parseBodyBlocks(arr) {
        const blocks = [];
        let curTitle = null;
        let curLines = [];

        function flush() {
          if (!curTitle && !curLines.length) return;
          blocks.push({ title: curTitle, text: curLines.join("\n") });
          curTitle = null;
          curLines = [];
        }

        (arr || []).forEach(line => {
          if (typeof line !== "string") return;
          const trim = line.trim();
          if (!trim) {
            curLines.push("");
            return;
          }
          if (/^#{2,}\s+/.test(trim)) {
            flush();
            curTitle = trim.replace(/^#{2,}\s+/, "").trim();
          } else {
            curLines.push(line);
          }
        });

        flush();
        return blocks;
      }

      function formatInline(t) {
        if (!t) return "";
        return t
          .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
          .replace(/_(.+?)_/g, "<em>$1</em>");
      }

      function bodyHTML(entry) {
        const blocks = parseBodyBlocks(normBody(entry));
        if (!blocks.length) return "";
        const out = [];
        blocks.forEach(b => {
          if (b.title) {
            out.push("<h3>" + formatInline(b.title) + "</h3>");
          }
          const lines = (b.text || "").split("\n");
          let bullets = [];
          function flushBullets() {
            if (!bullets.length) return;
            out.push("<ul>");
            bullets.forEach(l => out.push("<li>" + formatInline(l.replace(/^[-*]\s*/, "")) + "</li>"));
            out.push("</ul>");
            bullets = [];
          }
          lines.forEach(line => {
            const t = line.trim();
            if (!t) {
              flushBullets();
              out.push("<p>&nbsp;</p>");
            } else if (/^[-*]\s+/.test(t)) {
              bullets.push(t);
            } else {
              flushBullets();
              out.push("<p>" + formatInline(t) + "</p>");
            }
          });
          flushBullets();
        });
        return out.join("");
      }

      function buildCategories() {
        const set = new Set(["All"]);
        entries.forEach(e => { if (e.category) set.add(e.category); });
        categorySel.innerHTML = "";
        Array.from(set).sort((a, b) => {
          if (a === "All") return -1;
          if (b === "All") return 1;
          return a.localeCompare(b);
        }).forEach(cat => {
          const opt = document.createElement("option");
          opt.value = cat;
          opt.textContent = cat === "All" ? "All categories" : cat;
          categorySel.appendChild(opt);
        });
      }

      function filteredEntries() {
        const q   = (searchInput.value || "").trim();
        const cat = categorySel.value || "All";
        const arr = entries.map(e => {
          let include = true;
          if (cat !== "All" && e.category !== cat) include = false;
          let score = 0;
          if (q) {
            score = simpleScore(e, q);
            if (score <= 0) include = false;
          }
          return { entry: e, include, score };
        }).filter(x => x.include);

        if (q) {
          arr.sort((a, b) => {
            if (b.score !== a.score) return b.score - a.score;
            return (a.entry.title || "").localeCompare(b.entry.title || "");
          });
        } else {
          arr.sort((a, b) => {
            const ac = a.entry.category || "";
            const bc = b.entry.category || "";
            if (ac !== bc) return ac.localeCompare(bc);
            return (a.entry.title || "").localeCompare(b.entry.title || "");
          });
        }

        return arr.map(x => x.entry);
      }

      function dedupeAppears(raw) {
        if (!raw) return [];
        const map = new Map();
        raw.forEach(it => {
          if (!it) return;
          let bookId = "";
          let pages = null;

          if (typeof it === "string") {
            bookId = it;
          } else if (typeof it === "object") {
            bookId = it.bookId || it.book || "";
            pages = it.pages || it.page || null;
          }

          if (!bookId) return;
          const key = String(bookId);
          if (!map.has(key)) {
            map.set(key, { bookId: key, pages: [] });
          }
          const e = map.get(key);
          if (pages != null) {
            if (Array.isArray(pages)) {
              pages.forEach(p => e.pages.push(String(p)));
            } else {
              e.pages.push(String(pages));
            }
          }
        });

        const out = Array.from(map.values());
        out.forEach(o => {
          o.pages = Array.from(new Set(o.pages));
        });
        return out;
      }

      function readerUrl(bookId, firstPage) {
        const book = booksIndex[bookId];
        if (!book || !book.path) return null;
        const base = book.path.replace(/index\.html$/i, "reader.html");
        return firstPage ? base + "?p=" + encodeURIComponent(firstPage) : base;
      }

      function renderList() {
        const list = filteredEntries();
        listEl.innerHTML = "";
        countEl.textContent = `${entries.length} entries`;

        if (!list.length) {
          listEmptyEl.style.display = "";
          return;
        }
        listEmptyEl.style.display = "none";

        list.forEach(e => {
          const li = document.createElement("li");
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "cx-item-btn" + (e.id === activeId ? " active" : "");
          btn.dataset.id = e.id;

          const title = document.createElement("div");
          title.className = "cx-item-title";
          title.textContent = e.title || e.id || "Untitled";

          const meta = document.createElement("div");
          meta.className = "cx-item-meta";
          meta.textContent = e.category || "Uncategorized";

          btn.appendChild(title);
          btn.appendChild(meta);
          btn.addEventListener("click", () => {
            activeId = e.id;
            updateURL(activeId, categorySel.value, searchInput.value || "");
            renderList();
            renderEntry();
          });

          li.appendChild(btn);
          listEl.appendChild(li);
        });
      }

      function renderEntry() {
        const entry = entries.find(e => e.id === activeId) || null;

        if (!entry) {
          entryIdEl.textContent = "â€“";
          entryTitleEl.textContent = "Select a codex entry";
          entryTagsEl.textContent = "";
          entrySummaryEl.textContent = "Use the list on the left to choose an entry.";
          entryMetaEl.textContent = "â€“";
          bodyEl.innerHTML = "";
          bodyEmptyEl.style.display = "none";
          openBookEl.style.display = "none";
          appearsWrapEl.style.display = "none";
          return;
        }

        entryIdEl.textContent = entry.id || "â€“";
        entryTitleEl.textContent = entry.title || entry.id || "Untitled";

        const tagParts = [];
        if (entry.category) tagParts.push(entry.category);
        if (entry.type) tagParts.push(entry.type);
        if (entry.status) tagParts.push(entry.status);
        entryTagsEl.textContent = tagParts.join(" Â· ");

        entrySummaryEl.textContent = entry.summary || "";
        const appears = Array.isArray(entry.appearsIn) ? dedupeAppears(entry.appearsIn) : [];
        entryMetaEl.textContent = appears.length
          ? `Linked to ${appears.length} work${appears.length > 1 ? "s" : ""}.`
          : "No linked works.";

        const html = bodyHTML(entry);
        bodyEl.innerHTML = html;
        bodyEmptyEl.style.display = html ? "none" : "block";

        appearsListEl.innerHTML = "";
        if (!appears.length) {
          appearsWrapEl.style.display = "none";
          openBookEl.style.display = "none";
        } else {
          appearsWrapEl.style.display = "";
          appears.forEach(a => {
            const book = booksIndex[a.bookId];
            const label = (book && book.title) || a.bookId;
            const first = a.pages && a.pages.length ? a.pages[0] : null;
            const url = readerUrl(a.bookId, first) || "library.html";

            const link = document.createElement("a");
            link.className = "cx-appears-link";
            link.href = url;
            link.target = "_blank";
            link.textContent = label + (first ? ` (page ${first})` : "");
            appearsListEl.appendChild(link);
          });

          const a0 = appears[0];
          const url0 = readerUrl(a0.bookId, a0.pages && a0.pages[0]);
          if (url0) {
            openBookEl.href = url0;
            openBookEl.style.display = "inline-flex";
          } else {
            openBookEl.style.display = "none";
          }
        }
      }

      function attachEvents() {
        let t = null;
        function trigger() {
          if (t) clearTimeout(t);
          t = setTimeout(() => {
            updateURL(activeId, categorySel.value, searchInput.value || "");
            renderList();
          }, 120);
        }
        searchInput.addEventListener("input", trigger);
        categorySel.addEventListener("change", trigger);
      }

      function fetchBooks() {
        return fetch(BOOKS_JSON)
          .then(r => r.json())
          .then(data => {
            booksIndex = {};
            (data || []).forEach(b => {
              if (!b || !b.id) return;
              booksIndex[b.id] = b;
            });
          })
          .catch(err => console.warn("[codex] books.json load failed:", err));
      }

      function fetchCodex() {
        return fetch(CODEX_JSON)
          .then(r => r.json())
          .then(data => {
            entries = Array.isArray(data) ? data : [];
          })
          .catch(err => {
            console.error("[codex] codex.json load failed:", err);
            entries = [];
          });
      }

      function boot() {
        const params = qp();
        fetchBooks()
          .then(fetchCodex)
          .then(() => {
            countEl.textContent = `${entries.length} entries`;
            buildCategories();

            if (params.category && params.category !== "All") {
              categorySel.value = params.category;
            }
            if (params.q && params.q.trim()) {
              searchInput.value = params.q;
            }

            const list = filteredEntries();
            if (params.id && entries.some(e => e.id === params.id)) {
              activeId = params.id;
            } else if (list.length) {
              activeId = list[0].id;
            } else if (entries[0]) {
              activeId = entries[0].id;
            }

            renderList();
            renderEntry();
            attachEvents();
          });
      }

      boot();
    })();
  </script>
</body>
</html>
