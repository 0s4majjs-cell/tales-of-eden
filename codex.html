<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tales of Eden â€“ Codex</title>

  <!-- Global styles + theme loader -->
  <link rel="stylesheet" href="styles.css" />
  <script src="theme-loader.js"></script>

  <style>
    :root {
      --codex-radius-lg: 22px;
      --codex-radius-md: 14px;
      --codex-radius-pill: 999px;
      --codex-border-subtle: 1px solid rgba(148, 163, 184, 0.45);
      --codex-glass-dark: linear-gradient(
        145deg,
        rgba(3, 7, 18, 0.96),
        rgba(15, 23, 42, 0.96)
      );
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-ui, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif);
      color: var(--color-text-main, #e9f1ff);
      background:
        radial-gradient(circle at top, #1b2640 0, #050814 60%),
        #050814;
      background-attachment: fixed;
      display: flex;
      flex-direction: column;
    }

    .codex-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px clamp(14px, 4vw, 40px);
      gap: 14px;
    }

    /* Top bar */

    .codex-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .codex-logo-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .codex-logo-mark {
      width: 30px;
      height: 30px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 20%, #fbbf24 0, #f97316 18%, #4b5563 55%, #020617 100%);
      box-shadow: 0 0 24px rgba(248, 250, 252, 0.35);
      position: relative;
      overflow: hidden;
    }

    .codex-logo-mark::after {
      content: "";
      position: absolute;
      inset: 16%;
      border-radius: inherit;
      border: 1px solid rgba(15, 23, 42, 0.8);
    }

    .codex-logo-text {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .codex-logo-title {
      font-size: 15px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: rgba(226, 232, 255, 0.98);
    }

    .codex-logo-sub {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
    }

    .codex-top-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .codex-link-btn {
      padding: 7px 13px;
      border-radius: var(--codex-radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(226, 232, 255, 0.95);
      font-size: 11px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 7px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        transform 0.1s ease,
        box-shadow 0.15s ease;
      white-space: nowrap;
    }

    .codex-link-btn:hover {
      background: rgba(30, 64, 175, 0.95);
      border-color: rgba(191, 219, 254, 0.95);
      box-shadow: 0 0 0 1px rgba(191, 219, 254, 0.4);
      transform: translateY(-1px);
    }

    .codex-link-btn span.icon {
      font-size: 14px;
      opacity: 0.9;
    }

    /* Main layout */

    .codex-main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 2fr);
      gap: 16px;
      margin-top: 4px;
      min-height: 0;
    }

    @media (max-width: 900px) {
      .codex-main {
        grid-template-columns: minmax(0, 1fr);
        grid-template-rows: auto auto;
      }
    }

    /* Left panel: navigation */

    .codex-nav {
      border-radius: var(--codex-radius-lg);
      border: var(--codex-border-subtle);
      background: var(--codex-glass-dark);
      padding: 10px 10px 10px 12px;
      box-shadow:
        0 20px 60px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }

    .codex-nav-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .codex-nav-title {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.96);
    }

    .codex-nav-count {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.8);
    }

    .codex-search-wrap {
      margin-top: 2px;
    }

    .codex-search-input {
      width: 100%;
      border-radius: var(--codex-radius-pill);
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.96));
      color: rgba(226, 232, 255, 0.98);
      font-size: 12px;
      padding: 6px 10px 6px 26px;
      outline: none;
      transition:
        border-color 0.15s ease,
        box-shadow 0.15s ease,
        background 0.15s ease;
    }

    .codex-search-input::placeholder {
      color: rgba(148, 163, 184, 0.9);
    }

    .codex-search-field {
      position: relative;
    }

    .codex-search-field::before {
      content: "ðŸ”Ž";
      position: absolute;
      left: 7px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
      opacity: 0.9;
    }

    .codex-search-input:focus {
      border-color: rgba(96, 165, 250, 0.95);
      box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.7);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.96));
    }

    /* Category chips */

    .codex-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(30, 41, 59, 0.9);
    }

    .codex-cat-pill {
      padding: 4px 10px;
      border-radius: var(--codex-radius-pill);
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(148, 163, 184, 0.96);
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        color 0.15s ease,
        box-shadow 0.15s ease,
        transform 0.1s ease;
    }

    .codex-cat-pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
    }

    .codex-cat-pill.active {
      border-color: rgba(96, 165, 250, 0.95);
      color: rgba(226, 232, 255, 0.98);
      background: radial-gradient(circle at top, rgba(37, 99, 235, 0.35), rgba(15, 23, 42, 0.98));
      box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.7);
    }

    .codex-cat-pill.active span.dot {
      background: #60a5fa;
    }

    .codex-cat-pill:hover {
      transform: translateY(-1px);
      border-color: rgba(148, 163, 184, 0.9);
    }

    /* Entries list */

    .codex-entry-list-wrap {
      flex: 1;
      min-height: 0;
      margin-top: 4px;
    }

    .codex-entry-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 100%;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(51, 65, 85, 0.85) transparent;
    }

    .codex-entry-list::-webkit-scrollbar {
      width: 6px;
    }

    .codex-entry-list::-webkit-scrollbar-thumb {
      background: rgba(51, 65, 85, 0.9);
      border-radius: 999px;
    }

    .codex-entry-item {
      margin-bottom: 4px;
    }

    .codex-entry-btn {
      width: 100%;
      border: none;
      text-align: left;
      padding: 7px 8px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.9);
      color: rgba(226, 232, 255, 0.9);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
      transition:
        background 0.15s ease,
        box-shadow 0.15s ease,
        transform 0.1s ease;
    }

    .codex-entry-btn:hover {
      background: rgba(30, 64, 175, 0.96);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.9);
      transform: translateY(-1px);
    }

    .codex-entry-btn.active {
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.5), rgba(15, 23, 42, 0.98));
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.95);
    }

    .codex-entry-title {
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .codex-entry-meta {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.9);
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .codex-entry-meta span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .codex-entry-empty {
      font-size: 12px;
      color: rgba(148, 163, 184, 0.9);
      padding: 6px 2px;
    }

    /* Right panel: entry view */

    .codex-entry-panel {
      border-radius: var(--codex-radius-lg);
      border: var(--codex-border-subtle);
      background: var(--codex-glass-dark);
      padding: 14px 18px 16px 18px;
      box-shadow:
        0 22px 70px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .codex-entry-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      border-bottom: 1px solid rgba(30, 41, 59, 0.9);
      padding-bottom: 8px;
      margin-bottom: 4px;
    }

    .codex-entry-main-title {
      font-size: 18px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(226, 232, 255, 0.98);
      margin-bottom: 4px;
    }

    .codex-entry-id {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.9);
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }

    .codex-entry-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
    }

    .codex-chip {
      padding: 3px 9px;
      border-radius: var(--codex-radius-pill);
      border: 1px solid rgba(51, 65, 85, 0.95);
      background: rgba(15, 23, 42, 0.96);
      font-size: 11px;
      color: rgba(148, 163, 184, 0.96);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .codex-chip strong {
      font-weight: 500;
      color: rgba(226, 232, 255, 0.98);
    }

    .codex-entry-top-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
      flex-shrink: 0;
    }

    .codex-entry-open-book {
      padding: 5px 10px;
      border-radius: var(--codex-radius-pill);
      border: 1px solid rgba(96, 165, 250, 0.9);
      background: rgba(15, 23, 42, 0.98);
      color: rgba(226, 232, 255, 0.98);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      text-decoration: none;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        transform 0.1s ease,
        box-shadow 0.15s ease;
      white-space: nowrap;
    }

    .codex-entry-open-book:hover {
      background: rgba(37, 99, 235, 0.96);
      border-color: rgba(191, 219, 254, 1);
      box-shadow: 0 0 0 1px rgba(191, 219, 254, 0.6);
      transform: translateY(-1px);
    }

    .codex-entry-open-book span.icon {
      font-size: 13px;
      opacity: 0.9;
    }

    .codex-entry-meta-line {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.9);
      text-align: right;
    }

    /* Appears in section */

    .codex-appears {
      border-radius: var(--codex-radius-md);
      border: 1px solid rgba(30, 64, 175, 0.8);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.35), rgba(15, 23, 42, 0.98));
      padding: 8px 10px;
      margin-bottom: 4px;
    }

    .codex-appears-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: rgba(191, 219, 254, 0.96);
      margin-bottom: 4px;
    }

    .codex-appears-books {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .codex-appears-chip {
      padding: 3px 9px;
      border-radius: var(--codex-radius-pill);
      border: 1px solid rgba(191, 219, 254, 0.8);
      background: rgba(15, 23, 42, 0.98);
      color: rgba(226, 232, 255, 0.98);
      font-size: 11px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        transform 0.1s ease,
        box-shadow 0.15s ease;
      white-space: nowrap;
    }

    .codex-appears-chip:hover {
      background: rgba(37, 99, 235, 0.96);
      border-color: rgba(191, 219, 254, 1);
      box-shadow: 0 0 0 1px rgba(191, 219, 254, 0.6);
      transform: translateY(-1px);
    }

    .codex-appears-chip span.tagline {
      font-size: 10px;
      color: rgba(191, 219, 254, 0.9);
    }

    /* Body */

    .codex-entry-body-wrap {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: thin;
      scrollbar-color: rgba(51, 65, 85, 0.85) transparent;
    }

    .codex-entry-body-wrap::-webkit-scrollbar {
      width: 6px;
    }

    .codex-entry-body-wrap::-webkit-scrollbar-thumb {
      background: rgba(51, 65, 85, 0.9);
      border-radius: 999px;
    }

    .codex-entry-summary {
      font-size: 13px;
      color: rgba(191, 219, 254, 0.95);
      margin-bottom: 8px;
    }

    .codex-entry-body {
      font-size: 13px;
      line-height: 1.6;
      color: rgba(226, 232, 255, 0.96);
    }

    .codex-entry-body p {
      margin: 0 0 8px;
    }

    .codex-entry-body h3 {
      margin: 12px 0 4px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: rgba(191, 219, 254, 0.96);
    }

    .codex-entry-body ul {
      margin: 4px 0 8px 18px;
      padding: 0;
      font-size: 13px;
    }

    .codex-entry-body li {
      margin-bottom: 3px;
    }

    .codex-entry-empty-state {
      font-size: 13px;
      color: rgba(148, 163, 184, 0.9);
      margin-top: 6px;
    }

    /* Footer */

    .codex-footer {
      margin-top: 4px;
      padding: 4px 2px 0;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: rgba(148, 163, 184, 0.8);
      gap: 8px;
      border-top: 1px solid rgba(15, 23, 42, 0.9);
    }

    .codex-footer-links {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .codex-footer-links a {
      color: rgba(148, 163, 184, 0.9);
      text-decoration: none;
      border-bottom: 1px dotted rgba(55, 65, 81, 0.7);
    }

    .codex-footer-links a:hover {
      color: rgba(226, 232, 255, 0.98);
      border-bottom-color: rgba(156, 163, 175, 0.9);
    }

    @media (max-width: 700px) {
      .codex-entry-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .codex-entry-top-actions {
        align-items: flex-start;
      }
      .codex-shell {
        padding-inline: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="codex-shell">
    <!-- TOP BAR -->
    <header class="codex-topbar">
      <div class="codex-logo-group">
        <div class="codex-logo-mark"></div>
        <div class="codex-logo-text">
          <div class="codex-logo-title">Tales of Eden</div>
          <div class="codex-logo-sub">Codex / World Archive</div>
        </div>
      </div>

      <div class="codex-top-actions">
        <a href="index.html" class="codex-link-btn">
          <span class="icon">â—€</span>
          <span>Archive Hub</span>
        </a>
        <a href="library.html" class="codex-link-btn">
          <span class="icon">ðŸ“š</span>
          <span>Library</span>
        </a>
      </div>
    </header>

    <!-- MAIN -->
    <main class="codex-main">
      <!-- LEFT: NAVIGATION -->
      <aside class="codex-nav">
        <div class="codex-nav-header">
          <div class="codex-nav-title">Codex Index</div>
          <div class="codex-nav-count" id="codexCount">â€“ entries</div>
        </div>

        <div class="codex-search-wrap">
          <div class="codex-search-field">
            <input
              id="codexSearchInput"
              class="codex-search-input"
              type="search"
              placeholder="Search by name, id, or summaryâ€¦"
              autocomplete="off"
            />
          </div>
        </div>

        <div class="codex-categories" id="codexCategories"></div>

        <div class="codex-entry-list-wrap">
          <ul class="codex-entry-list" id="codexEntryList">
            <!-- populated by JS -->
          </ul>
          <div class="codex-entry-empty" id="codexEntryEmpty" style="display: none;">
            No entries match this view.
          </div>
        </div>
      </aside>

      <!-- RIGHT: ENTRY VIEW -->
      <section class="codex-entry-panel">
        <header class="codex-entry-header">
          <div>
            <div class="codex-entry-id" id="codexEntryId">â€“</div>
            <h1 class="codex-entry-main-title" id="codexEntryTitle">Select a codex entry</h1>
            <div class="codex-entry-chips" id="codexEntryChips"></div>
          </div>

          <div class="codex-entry-top-actions">
            <a id="codexOpenBookBtn" href="library.html" class="codex-entry-open-book" style="display:none;">
              <span class="icon">ðŸ“–</span>
              <span>Open related book</span>
            </a>
            <div class="codex-entry-meta-line" id="codexEntryMetaLine">
              â€“
            </div>
          </div>
        </header>

        <div id="codexAppearsSection" class="codex-appears" style="display:none;">
          <div class="codex-appears-title">Appears In</div>
          <div class="codex-appears-books" id="codexAppearsBooks"></div>
        </div>

        <div class="codex-entry-body-wrap">
          <p class="codex-entry-summary" id="codexEntrySummary">
            Use the index on the left to select an entry.
          </p>
          <div class="codex-entry-body" id="codexEntryBody"></div>

          <div class="codex-entry-empty-state" id="codexEntryEmptyState" style="display:none;">
            No additional body content available for this entry.
          </div>
        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer class="codex-footer">
      <span>Tales of Eden â€“ Codex</span>
      <div class="codex-footer-links">
        <a href="index.html">Hub</a>
        <a href="library.html">Library</a>
      </div>
    </footer>
  </div>

  <script>
    (function () {
      const CODEX_JSON = "Codex/codex.json";
      const BOOKS_JSON = "books.json";

      const countEl = document.getElementById("codexCount");
      const catContainer = document.getElementById("codexCategories");
      const searchInput = document.getElementById("codexSearchInput");
      const listEl = document.getElementById("codexEntryList");
      const listEmptyEl = document.getElementById("codexEntryEmpty");

      const entryIdEl = document.getElementById("codexEntryId");
      const entryTitleEl = document.getElementById("codexEntryTitle");
      const entryChipsEl = document.getElementById("codexEntryChips");
      const entrySummaryEl = document.getElementById("codexEntrySummary");
      const entryBodyEl = document.getElementById("codexEntryBody");
      const entryEmptyStateEl = document.getElementById("codexEntryEmptyState");
      const entryMetaLineEl = document.getElementById("codexEntryMetaLine");
      const openBookBtn = document.getElementById("codexOpenBookBtn");

      const appearsSectionEl = document.getElementById("codexAppearsSection");
      const appearsBooksEl = document.getElementById("codexAppearsBooks");

      let entries = [];
      let booksIndex = {};
      let categorySet = new Set();
      let activeCategory = "All";
      let activeEntryId = null;

      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          id: params.get("id") || null,
          q: params.get("q") || "",
          category: params.get("category") || null
        };
      }

      function updateUrl(id, category, q) {
        const params = new URLSearchParams();
        if (id) params.set("id", id);
        if (category && category !== "All") params.set("category", category);
        if (q && q.trim()) params.set("q", q.trim());
        const newUrl = window.location.pathname + "?" + params.toString();
        window.history.replaceState(null, "", newUrl);
      }

      function simpleSearchScore(entry, query) {
        if (!query) return 0;
        const q = query.toLowerCase();
        let score = 0;
        if (entry.title && entry.title.toLowerCase().includes(q)) score += 3;
        if (entry.id && entry.id.toLowerCase().includes(q)) score += 2;
        if (entry.category && entry.category.toLowerCase().includes(q)) score += 1;
        if (entry.summary && entry.summary.toLowerCase().includes(q)) score += 1;
        return score;
      }

      function normalizeBody(entry) {
        if (!entry) return [];
        if (Array.isArray(entry.body)) return entry.body;
        if (typeof entry.body === "string") return [entry.body];
        return [];
      }

      function parseBulletSections(bodyArray) {
        const blocks = [];
        let currentLines = [];
        let currentTitle = null;

        function flushBlock() {
          if (!currentLines.length && !currentTitle) return;
          const text = currentLines.join("\n").trim();
          if (!text) return;
          blocks.push({
            title: currentTitle,
            text
          });
          currentLines = [];
          currentTitle = null;
        }

        (bodyArray || []).forEach(line => {
          if (typeof line !== "string") return;
          const trimmed = line.trim();
          if (!trimmed) {
            currentLines.push("");
            return;
          }
          // Simple section header detection: "## Something"
          if (/^#{2,}\s+/.test(trimmed)) {
            flushBlock();
            currentTitle = trimmed.replace(/^#{2,}\s+/, "").trim();
          } else {
            currentLines.push(line);
          }
        });

        flushBlock();
        return blocks;
      }

      function formatInline(text) {
        if (!text) return "";
        // brave but simple: **bold** and _italic_
        return text
          .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
          .replace(/_(.+?)_/g, "<em>$1</em>");
      }

      function buildBodyHtml(entry) {
        const rawBody = normalizeBody(entry);
        const blocks = parseBulletSections(rawBody);
        if (!blocks.length) return "";

        const htmlParts = [];

        blocks.forEach(block => {
          const text = block.text || "";
          if (block.title) {
            htmlParts.push("<h3>" + formatInline(block.title) + "</h3>");
          }
          // bullet detection: lines starting with "- " or "* "
          const lines = text.split("\n");
          let bulletMode = false;
          let bulletBuf = [];

          function flushBullets() {
            if (!bulletBuf.length) return;
            htmlParts.push("<ul>");
            bulletBuf.forEach(line => {
              htmlParts.push("<li>" + formatInline(line.replace(/^[-*]\s*/, "")) + "</li>");
            });
            htmlParts.push("</ul>");
            bulletBuf = [];
          }

          lines.forEach(line => {
            const trimmed = line.trim();
            if (!trimmed) {
              flushBullets();
              htmlParts.push("<p>&nbsp;</p>");
            } else if (/^[-*]\s+/.test(trimmed)) {
              bulletMode = true;
              bulletBuf.push(trimmed);
            } else {
              flushBullets();
              bulletMode = false;
              htmlParts.push("<p>" + formatInline(trimmed) + "</p>");
            }
          });

          flushBullets();
        });

        return htmlParts.join("");
      }

      function buildCategorySet() {
        categorySet = new Set(["All"]);
        entries.forEach(e => {
          if (e.category) categorySet.add(e.category);
        });
      }

      function renderCategories() {
        if (!catContainer) return;
        catContainer.innerHTML = "";

        const categories = Array.from(categorySet);
        categories.sort((a, b) => {
          if (a === "All") return -1;
          if (b === "All") return 1;
          return a.localeCompare(b);
        });

        categories.forEach(cat => {
          const pill = document.createElement("button");
          pill.type = "button";
          pill.className = "codex-cat-pill" + (cat === activeCategory ? " active" : "");
          pill.innerHTML = `<span class="dot"></span><span>${cat}</span>`;
          pill.addEventListener("click", () => {
            activeCategory = cat;
            updateUrl(activeEntryId, activeCategory, searchInput.value || "");
            renderCategories();
            renderEntryList();
          });
          catContainer.appendChild(pill);
        });
      }

      function filteredEntries() {
        const query = (searchInput.value || "").trim();
        const q = query.toLowerCase();
        const cat = activeCategory;

        const scored = entries.map(e => {
          let include = true;
          if (cat && cat !== "All" && e.category !== cat) include = false;
          let score = 0;
          if (q) {
            const s = simpleSearchScore(e, q);
            if (s <= 0) include = false;
            score = s;
          }
          return { entry: e, include, score };
        }).filter(x => x.include);

        // sort: if query, by score desc then title; else by category+title
        if (q) {
          scored.sort((a, b) => {
            if (b.score !== a.score) return b.score - a.score;
            return (a.entry.title || "").localeCompare(b.entry.title || "");
          });
        } else {
          scored.sort((a, b) => {
            const ac = a.entry.category || "";
            const bc = b.entry.category || "";
            if (ac !== bc) return ac.localeCompare(bc);
            return (a.entry.title || "").localeCompare(b.entry.title || "");
          });
        }

        return scored.map(s => s.entry);
      }

      function renderEntryList() {
        if (!listEl || !listEmptyEl) return;
        const subset = filteredEntries();

        listEl.innerHTML = "";
        if (!subset.length) {
          listEmptyEl.style.display = "";
          return;
        } else {
          listEmptyEl.style.display = "none";
        }

        subset.forEach(e => {
          const li = document.createElement("li");
          li.className = "codex-entry-item";

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "codex-entry-btn" + (e.id === activeEntryId ? " active" : "");
          btn.dataset.entryId = e.id;

          const t = document.createElement("div");
          t.className = "codex-entry-title";
          t.textContent = e.title || e.id || "Untitled";

          const meta = document.createElement("div");
          meta.className = "codex-entry-meta";

          const catSpan = document.createElement("span");
          catSpan.textContent = e.category || "Uncategorized";

          const short = document.createElement("span");
          const s = e.summary || "";
          short.textContent = s.length > 42 ? s.slice(0, 40) + "â€¦" : s;

          meta.appendChild(catSpan);
          meta.appendChild(short);

          btn.appendChild(t);
          btn.appendChild(meta);

          btn.addEventListener("click", () => {
            activeEntryId = e.id;
            updateUrl(activeEntryId, activeCategory, searchInput.value || "");
            renderEntryList();
            renderEntryDetail();
          });

          li.appendChild(btn);
          listEl.appendChild(li);
        });
      }

      function dedupeAppearsIn(raw) {
        if (!raw) return [];
        // Accept forms:
        // - "Alexander"
        // - { bookId: "Alexander", pages: [10, 20] }
        // - { book: "Alexander Colt", pages: "10â€“20" }
        const map = new Map();

        raw.forEach(it => {
          if (!it) return;
          let bookId = "";
          let pages = null;

          if (typeof it === "string") {
            bookId = it;
          } else if (typeof it === "object") {
            bookId = it.bookId || it.book || "";
            pages = it.pages || it.page || null;
          }

          if (!bookId) return;
          const key = String(bookId);

          if (!map.has(key)) {
            map.set(key, { bookId: key, pages: [] });
          }
          const entry = map.get(key);

          if (pages != null) {
            if (Array.isArray(pages)) {
              pages.forEach(p => {
                if (typeof p === "number" || typeof p === "string") {
                  entry.pages.push(p);
                }
              });
            } else {
              entry.pages.push(pages);
            }
          }
        });

        const out = Array.from(map.values());
        out.forEach(o => {
          // dedupe pages & stringify
          o.pages = Array.from(new Set(o.pages.map(x => String(x))));
        });
        return out;
      }

      function buildReaderUrlForBookId(bookId, firstPage) {
        const book = booksIndex[bookId] || null;
        if (!book) return null;
        const path = book.path || "";
        if (!path) return null;
        const base = path.replace(/index\.html$/i, "reader.html");
        if (!firstPage) return base;
        return base + "?p=" + encodeURIComponent(firstPage);
      }

      function pickPrimaryBookForEntry(entry) {
        if (!entry || !entry.appearsIn || !entry.appearsIn.length) return null;
        const deduped = dedupeAppearsIn(entry.appearsIn);
        return deduped[0] || null;
      }

      function renderAppearsIn(entry) {
        if (!appearsSectionEl || !appearsBooksEl) return;
        appearsBooksEl.innerHTML = "";

        if (!entry || !entry.appearsIn || !entry.appearsIn.length) {
          appearsSectionEl.style.display = "none";
          return;
        }

        const deduped = dedupeAppearsIn(entry.appearsIn);
        if (!deduped.length) {
          appearsSectionEl.style.display = "none";
          return;
        }

        deduped.forEach(item => {
          const bookId = item.bookId;
          const book = booksIndex[bookId] || null;
          const label = (book && book.title) || bookId;
          const firstPage = item.pages && item.pages.length ? item.pages[0] : null;

          const a = document.createElement("a");
          a.className = "codex-appears-chip";
          const url = buildReaderUrlForBookId(bookId, firstPage);
          a.href = url || "library.html";
          a.target = "_blank";

          const mainSpan = document.createElement("span");
          mainSpan.textContent = label;

          a.appendChild(mainSpan);

          if (item.pages && item.pages.length) {
            const tagSpan = document.createElement("span");
            tagSpan.className = "tagline";
            if (item.pages.length === 1) {
              tagSpan.textContent = "page " + item.pages[0];
            } else {
              tagSpan.textContent = "pages " + item.pages[0] + "â€¦";
            }
            a.appendChild(tagSpan);
          }

          appearsBooksEl.appendChild(a);
        });

        appearsSectionEl.style.display = "";
      }

      function renderEntryDetail() {
        const entry = entries.find(e => e.id === activeEntryId) || null;

        if (!entry) {
          entryIdEl.textContent = "â€“";
          entryTitleEl.textContent = "No entry selected";
          entryChipsEl.innerHTML = "";
          entrySummaryEl.textContent = "Use the index on the left to choose an entry.";
          entryBodyEl.innerHTML = "";
          entryEmptyStateEl.style.display = "none";
          entryMetaLineEl.textContent = "0 entries loaded";
          openBookBtn.style.display = "none";
          appearsSectionEl.style.display = "none";
          return;
        }

        entryIdEl.textContent = entry.id || "â€“";
        entryTitleEl.textContent = entry.title || entry.id || "Untitled";

        // Chips: category, type, etc.
        entryChipsEl.innerHTML = "";
        if (entry.category) {
          const catChip = document.createElement("div");
          catChip.className = "codex-chip";
          catChip.innerHTML = `<strong>Category</strong><span>${entry.category}</span>`;
          entryChipsEl.appendChild(catChip);
        }
        if (entry.type) {
          const typeChip = document.createElement("div");
          typeChip.className = "codex-chip";
          typeChip.innerHTML = `<strong>Type</strong><span>${entry.type}</span>`;
          entryChipsEl.appendChild(typeChip);
        }
        if (entry.status) {
          const statusChip = document.createElement("div");
          statusChip.className = "codex-chip";
          statusChip.innerHTML = `<strong>Status</strong><span>${entry.status}</span>`;
          entryChipsEl.appendChild(statusChip);
        }

        // Summary
        if (entry.summary) {
          entrySummaryEl.textContent = entry.summary;
        } else {
          entrySummaryEl.textContent = "";
        }

        // Body
        const bodyHtml = buildBodyHtml(entry);
        entryBodyEl.innerHTML = bodyHtml;

        if (!bodyHtml && !entry.summary) {
          entryEmptyStateEl.style.display = "";
        } else {
          entryEmptyStateEl.style.display = "none";
        }

        // Meta line
        const catText = entry.category || "Uncategorized";
        const appearsCount = Array.isArray(entry.appearsIn) ? dedupeAppearsIn(entry.appearsIn).length : 0;
        const appearsText = appearsCount ? `Appears in ${appearsCount} work${appearsCount > 1 ? "s" : ""}` : "No linked works";
        entryMetaLineEl.textContent = `${catText} Â· ${appearsText}`;

        // Appears in section
        renderAppearsIn(entry);

        // Open primary related book button
        const mainAppear = pickPrimaryBookForEntry(entry);
        if (mainAppear) {
          const url = buildReaderUrlForBookId(mainAppear.bookId, mainAppear.pages && mainAppear.pages[0]);
          if (url) {
            openBookBtn.href = url;
            openBookBtn.style.display = "";
          } else {
            openBookBtn.style.display = "none";
          }
        } else {
          openBookBtn.style.display = "none";
        }
      }

      function attachEvents() {
        if (!searchInput) return;
        let searchDebounce = null;

        searchInput.addEventListener("input", () => {
          if (searchDebounce) clearTimeout(searchDebounce);
          searchDebounce = setTimeout(() => {
            updateUrl(activeEntryId, activeCategory, searchInput.value || "");
            renderEntryList();
          }, 130);
        });
      }

      function fetchBooks() {
        return fetch(BOOKS_JSON)
          .then(r => r.json())
          .then(data => {
            booksIndex = {};
            (data || []).forEach(b => {
              if (!b || !b.id) return;
              booksIndex[b.id] = b;
            });
          })
          .catch(err => {
            console.warn("[codex] Failed to load books.json:", err);
          });
      }

      function fetchCodex() {
        return fetch(CODEX_JSON)
          .then(r => r.json())
          .then(data => {
            entries = Array.isArray(data) ? data : [];
            if (countEl) {
              countEl.textContent = entries.length + " entries";
            }
          })
          .catch(err => {
            console.error("[codex] Failed to load Codex:", err);
            entries = [];
            if (countEl) countEl.textContent = "0 entries";
          });
      }

      function boot() {
        const qp = getQueryParams();
        activeCategory = qp.category || "All";

        fetchBooks()
          .then(fetchCodex)
          .then(() => {
            buildCategorySet();
            renderCategories();

            if (searchInput && qp.q) {
              searchInput.value = qp.q;
            }

            // Set initial active entry
            if (qp.id && entries.some(e => e.id === qp.id)) {
              activeEntryId = qp.id;
            } else {
              const subset = filteredEntries();
              activeEntryId = subset.length ? subset[0].id : (entries[0] && entries[0].id) || null;
            }

            renderEntryList();
            renderEntryDetail();
            attachEvents();
          });
      }

      boot();
    })();
  </script>
</body>
</html>
