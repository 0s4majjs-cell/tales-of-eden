<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tales of Eden â€“ Codex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Global styles + theme loader -->
  <link rel="stylesheet" href="styles.css" />
  <script src="theme-loader.js"></script>

  <style>
    :root {
      --codex-radius-lg: 22px;
      --codex-radius-md: 14px;
      --codex-radius-pill: 999px;
      --codex-border-subtle: 1px solid rgba(148, 163, 184, 0.45);
      --codex-glass-dark: linear-gradient(
        145deg,
        rgba(3, 7, 18, 0.96),
        rgba(15, 23, 42, 0.96)
      );
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-ui, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif);
      color: var(--color-text-main, #e9f1ff);
      background:
        radial-gradient(circle at 10% 0%, rgba(56, 189, 248, 0.18), transparent 55%),
        radial-gradient(circle at 90% 100%, rgba(129, 140, 248, 0.25), transparent 60%),
        linear-gradient(to bottom, #020617, #020617 55%, #020617);
      background-attachment: fixed;
      display: flex;
      flex-direction: column;
    }

    .codex-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px clamp(14px, 4vw, 40px);
      gap: 14px;
    }

    /* TOP BAR */

    .codex-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .codex-logo-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .codex-logo-mark {
      width: 30px;
      height: 30px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 20%, #38bdf8 0, #6366f1 28%, #020617 75%);
      box-shadow: 0 0 24px rgba(129, 140, 248, 0.6);
      position: relative;
      overflow: hidden;
    }

    .codex-logo-mark::after {
      content: "";
      position: absolute;
      inset: 16%;
      border-radius: inherit;
      border: 1px solid rgba(15, 23, 42, 0.8);
    }

    .codex-logo-text {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .codex-logo-title {
      font-size: 15px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(226, 232, 255, 0.96);
    }

    .codex-logo-sub {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
    }

    .codex-top-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .codex-link-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.9);
      color: rgba(226, 232, 255, 0.96);
      font-size: 12px;
      text-decoration: none;
      cursor: pointer;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        transform 0.1s ease,
        box-shadow 0.15s ease;
    }

    .codex-link-btn .icon { font-size: 13px; }

    .codex-link-btn:hover {
      background: rgba(30, 64, 175, 0.96);
      border-color: rgba(96, 165, 250, 0.95);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.9);
      transform: translateY(-1px);
    }

    /* MAIN LAYOUT */

    .codex-main {
      display: grid;
      grid-template-columns: minmax(260px, 320px) minmax(0, 1fr);
      gap: 14px;
      margin-top: 6px;
      flex: 1;
      min-height: 0;
    }

    .codex-nav {
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-radius: var(--codex-radius-lg);
      border: var(--codex-border-subtle);
      background: var(--codex-glass-dark);
      padding: 10px 10px 10px 10px;
      box-shadow:
        0 18px 45px rgba(15, 23, 42, 0.98),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      min-height: 0;
    }

    .codex-entry-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-radius: var(--codex-radius-lg);
      border: var(--codex-border-subtle);
      background: var(--codex-glass-dark);
      padding: 10px 12px;
      box-shadow:
        0 22px 60px rgba(15, 23, 42, 0.98),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      min-height: 0;
      flex: 1;
    }

    .codex-nav-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .codex-nav-title {
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(209, 213, 219, 0.98);
    }

    .codex-nav-count {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.95);
    }

    /* SEARCH */

    .codex-search-wrap { margin-top: 4px; }

    .codex-search-field { position: relative; }

    .codex-search-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(226, 232, 255, 0.96);
      font-size: 12px;
      padding: 6px 10px;
      outline: none;
      transition:
        border-color 0.15s ease,
        box-shadow 0.15s ease,
        background 0.15s ease;
    }

    .codex-search-input::placeholder {
      color: rgba(148, 163, 184, 0.9);
    }

    .codex-search-input:focus {
      border-color: rgba(96, 165, 250, 0.95);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.6);
      background: rgba(15, 23, 42, 1);
    }

    /* CATEGORIES */

    .codex-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .codex-cat-pill {
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: rgba(209, 213, 219, 0.96);
      font-size: 11px;
      padding: 3px 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        box-shadow 0.15s ease,
        transform 0.08s ease;
    }

    .codex-cat-pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.9);
    }

    .codex-cat-pill.active {
      border-color: rgba(96, 165, 250, 0.95);
      color: rgba(226, 232, 255, 0.98);
      background: radial-gradient(circle at top, rgba(37, 99, 235, 0.35), rgba(15, 23, 42, 0.98));
      box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.7);
    }

    .codex-cat-pill.active span.dot { background: #60a5fa; }

    .codex-cat-pill:hover {
      transform: translateY(-1px);
      border-color: rgba(148, 163, 184, 0.9);
    }

    /* ENTRY LIST */

    .codex-entry-list-wrap {
      flex: 1;
      min-height: 0;
      margin-top: 4px;
    }

    .codex-entry-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 100%;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(51, 65, 85, 0.85) transparent;
    }

    .codex-entry-list::-webkit-scrollbar { width: 6px; }

    .codex-entry-list::-webkit-scrollbar-thumb {
      background: rgba(51, 65, 85, 0.9);
      border-radius: 999px;
    }

    .codex-entry-item { margin-bottom: 4px; }

    .codex-entry-btn {
      width: 100%;
      border: none;
      text-align: left;
      padding: 7px 8px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.9);
      color: rgba(226, 232, 255, 0.9);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
      transition:
        background 0.15s ease,
        box-shadow 0.15s ease,
        transform 0.1s ease;
    }

    .codex-entry-btn:hover {
      background: rgba(30, 64, 175, 0.96);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.9);
      transform: translateY(-1px);
    }

    .codex-entry-btn.active {
      background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.5), rgba(15, 23, 42, 0.98));
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.95);
    }

    .codex-entry-title {
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .codex-entry-meta {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.9);
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .codex-entry-tag {
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .codex-entry-empty {
      margin-top: 8px;
      font-size: 12px;
      color: rgba(148, 163, 184, 0.9);
    }

    /* ENTRY PANEL HEADER */

    .codex-entry-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .codex-entry-id {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
      margin-bottom: 2px;
    }

    .codex-entry-main-title {
      font-size: 18px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin: 0 0 4px;
      color: rgba(226, 232, 255, 0.98);
    }

    .codex-entry-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .codex-entry-chip {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.98);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 2px 8px;
      color: rgba(191, 219, 254, 0.95);
    }

    .codex-entry-top-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      font-size: 11px;
      color: rgba(148, 163, 184, 0.9);
    }

    .codex-entry-open-book {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(96, 165, 250, 0.95);
      background: rgba(15, 23, 42, 0.98);
      color: rgba(219, 234, 254, 0.98);
      font-size: 11px;
      text-decoration: none;
      cursor: pointer;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        transform 0.1s ease,
        box-shadow 0.15s ease;
    }

    .codex-entry-open-book .icon { font-size: 13px; }

    .codex-entry-open-book:hover {
      background: rgba(37, 99, 235, 0.98);
      border-color: rgba(191, 219, 254, 1);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.98);
      transform: translateY(-1px);
    }

    .codex-entry-meta-line {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.9);
      text-align: right;
    }

    /* APPEARS IN */

    .codex-appears {
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px dashed rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .codex-appears-title {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.95);
    }

    .codex-appears-books {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .codex-appears-chip {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.98);
      font-size: 11px;
      padding: 3px 8px;
      color: rgba(219, 234, 254, 0.98);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        box-shadow 0.15s ease,
        transform 0.08s ease;
    }

    .codex-appears-chip .tagline {
      font-size: 10px;
      color: rgba(148, 163, 184, 0.95);
    }

    .codex-appears-chip:hover {
      background: rgba(30, 64, 175, 0.96);
      border-color: rgba(96, 165, 250, 0.95);
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.98);
      transform: translateY(-1px);
    }

    /* ENTRY BODY */

    .codex-entry-body-wrap {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: thin;
      scrollbar-color: rgba(51, 65, 85, 0.85) transparent;
    }

    .codex-entry-body-wrap::-webkit-scrollbar { width: 6px; }

    .codex-entry-body-wrap::-webkit-scrollbar-thumb {
      background: rgba(51, 65, 85, 0.9);
      border-radius: 999px;
    }

    .codex-entry-summary {
      font-size: 13px;
      color: rgba(191, 219, 254, 0.95);
      margin-bottom: 8px;
    }

    .codex-entry-body {
      font-size: 13px;
      line-height: 1.6;
      color: rgba(226, 232, 255, 0.96);
    }

    .codex-entry-body p { margin: 0 0 8px; }

    .codex-entry-body h3 {
      margin: 12px 0 4px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: rgba(191, 219, 254, 0.96);
    }

    .codex-entry-empty-state {
      font-size: 13px;
      color: rgba(148, 163, 184, 0.9);
      margin-top: 6px;
    }

    /* FOOTER */

    .codex-footer {
      margin-top: 4px;
      padding: 4px 2px 0;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: rgba(148, 163, 184, 0.8);
      gap: 8px;
      border-top: 1px solid rgba(15, 23, 42, 0.9);
    }

    .codex-footer-links {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .codex-footer-links a {
      color: rgba(148, 163, 184, 0.9);
      text-decoration: none;
      border-bottom: 1px dotted rgba(55, 65, 81, 0.7);
    }

    .codex-footer-links a:hover {
      color: rgba(226, 232, 255, 0.98);
      border-bottom-color: rgba(156, 163, 175, 0.9);
    }

    @media (max-width: 900px) {
      .codex-main {
        grid-template-columns: minmax(0, 1fr);
      }
      .codex-nav {
        order: 1;
      }
      .codex-entry-panel {
        order: 0;
      }
    }

    @media (max-width: 700px) {
      .codex-entry-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .codex-entry-top-actions {
        align-items: flex-start;
      }
      .codex-shell {
        padding-inline: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="codex-shell">
    <!-- TOP BAR -->
    <header class="codex-topbar">
      <div class="codex-logo-group">
        <div class="codex-logo-mark"></div>
        <div class="codex-logo-text">
          <div class="codex-logo-title">Tales of Eden</div>
          <div class="codex-logo-sub">Codex / World Archive</div>
        </div>
      </div>

      <div class="codex-top-actions">
        <a href="timeline.html" class="codex-link-btn">
          <span class="icon">ðŸ•’</span>
          <span>Timeline</span>
        </a>
        <a href="library.html" class="codex-link-btn">
          <span class="icon">ðŸ“š</span>
          <span>Library</span>
        </a>
      </div>
    </header>

    <!-- MAIN -->
    <main class="codex-main">
      <!-- LEFT: NAVIGATION -->
      <aside class="codex-nav">
        <div class="codex-nav-header">
          <div class="codex-nav-title">Codex Index</div>
          <div class="codex-nav-count" id="codexCount">â€“ entries</div>
        </div>

        <div class="codex-search-wrap">
          <div class="codex-search-field">
            <input
              id="codexSearchInput"
              class="codex-search-input"
              type="search"
              placeholder="Search by name, id, or summaryâ€¦"
              autocomplete="off"
            />
          </div>
        </div>

        <div class="codex-categories" id="codexCategories"></div>

        <div class="codex-entry-list-wrap">
          <ul class="codex-entry-list" id="codexEntryList"></ul>
          <div class="codex-entry-empty" id="codexEntryEmpty" style="display: none;">
            No entries match this view.
          </div>
        </div>
      </aside>

      <!-- RIGHT: ENTRY PANEL -->
      <section class="codex-entry-panel">
        <header class="codex-entry-header">
          <div>
            <div class="codex-entry-id" id="codexEntryId">â€“</div>
            <h1 class="codex-entry-main-title" id="codexEntryTitle">Select a codex entry</h1>
            <div class="codex-entry-chips" id="codexEntryChips"></div>
          </div>

          <div class="codex-entry-top-actions">
            <a id="codexOpenBookBtn" href="library.html" class="codex-entry-open-book" style="display:none;">
              <span class="icon">ðŸ“–</span>
              <span>Open related book</span>
            </a>
            <div class="codex-entry-meta-line" id="codexEntryMetaLine">â€“</div>
          </div>
        </header>

        <div id="codexAppearsSection" class="codex-appears" style="display:none;">
          <div class="codex-appears-title">Appears In</div>
          <div class="codex-appears-books" id="codexAppearsBooks"></div>
        </div>

        <div class="codex-entry-body-wrap">
          <p class="codex-entry-summary" id="codexEntrySummary">
            Use the index on the left to select an entry.
          </p>
          <div class="codex-entry-body" id="codexEntryBody"></div>

          <div class="codex-entry-empty-state" id="codexEntryEmptyState" style="display:none;">
            No additional body content available for this entry.
          </div>
        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer class="codex-footer">
      <span>Tales of Eden â€“ Codex</span>
      <div class="codex-footer-links">
        <a href="timeline.html">Timeline</a>
        <a href="library.html">Library</a>
      </div>
    </footer>
  </div>

  <script>
    (function () {
      const CODEX_JSON = "Codex/codex.json";
      const BOOKS_JSON = "books.json";

      const countEl       = document.getElementById("codexCount");
      const catContainer  = document.getElementById("codexCategories");
      const searchInput   = document.getElementById("codexSearchInput");
      const listEl        = document.getElementById("codexEntryList");
      const listEmptyEl   = document.getElementById("codexEntryEmpty");

      const entryIdEl          = document.getElementById("codexEntryId");
      const entryTitleEl       = document.getElementById("codexEntryTitle");
      const entryChipsEl       = document.getElementById("codexEntryChips");
      const entrySummaryEl     = document.getElementById("codexEntrySummary");
      const entryBodyEl        = document.getElementById("codexEntryBody");
      const entryEmptyStateEl  = document.getElementById("codexEntryEmptyState");
      const entryMetaLineEl    = document.getElementById("codexEntryMetaLine");
      const openBookBtn        = document.getElementById("codexOpenBookBtn");
      const appearsSectionEl   = document.getElementById("codexAppearsSection");
      const appearsBooksEl     = document.getElementById("codexAppearsBooks");

      let entries       = [];
      let booksIndex    = {};
      let categorySet   = new Set();
      let activeCategory= "All";
      let activeEntryId = null;

      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          id: params.get("id") || null,
          q:  params.get("q") || "",
          category: params.get("category") || null
        };
      }

      function updateUrl(id, category, q) {
        const params = new URLSearchParams();
        if (id) params.set("id", id);
        if (category && category !== "All") params.set("category", category);
        if (q && q.trim()) params.set("q", q.trim());
        const newUrl = window.location.pathname + (params.toString() ? "?" + params.toString() : "");
        window.history.replaceState(null, "", newUrl);
      }

      function simpleSearchScore(entry, query) {
        if (!query) return 0;
        const q = query.toLowerCase();
        let score = 0;
        if (entry.title && entry.title.toLowerCase().includes(q))   score += 3;
        if (entry.id && entry.id.toLowerCase().includes(q))         score += 2;
        if (entry.category && entry.category.toLowerCase().includes(q)) score += 1;
        if (entry.summary && entry.summary.toLowerCase().includes(q))   score += 1;
        return score;
      }

      function buildCategorySet() {
        categorySet = new Set();
        categorySet.add("All");
        entries.forEach(e => {
          if (e.category) categorySet.add(e.category);
        });
      }

      function renderCategories() {
        if (!catContainer) return;
        catContainer.innerHTML = "";
        const cats = Array.from(categorySet).sort((a, b) => {
          if (a === "All") return -1;
          if (b === "All") return 1;
          return a.localeCompare(b);
        });

        cats.forEach(cat => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "codex-cat-pill" + (cat === activeCategory ? " active" : "");
          btn.innerHTML = `<span class="dot"></span><span>${cat}</span>`;
          btn.addEventListener("click", () => {
            activeCategory = cat;
            renderCategories();
            renderEntryList();
            updateUrl(activeEntryId, activeCategory, (searchInput && searchInput.value) || "");
          });
          catContainer.appendChild(btn);
        });
      }

      function filteredEntries() {
        const q = (searchInput && searchInput.value || "").trim().toLowerCase();
        return entries
          .filter(e => {
            if (activeCategory !== "All" && e.category !== activeCategory) return false;
            if (!q) return true;
            return simpleSearchScore(e, q) > 0;
          })
          .sort((a, b) => {
            if (q) {
              const sa = simpleSearchScore(a, q);
              const sb = simpleSearchScore(b, q);
              if (sa !== sb) return sb - sa;
            }
            return (a.title || "").localeCompare(b.title || "");
          });
      }

      function renderEntryList() {
        if (!listEl || !listEmptyEl) return;
        const subset = filteredEntries();
        listEl.innerHTML = "";

        if (!subset.length) {
          listEmptyEl.style.display = "";
          return;
        }

        listEmptyEl.style.display = "none";

        subset.forEach(entry => {
          const li = document.createElement("li");
          li.className = "codex-entry-item";

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "codex-entry-btn" + (entry.id === activeEntryId ? " active" : "");
          btn.dataset.entryId = entry.id;

          const titleSpan = document.createElement("div");
          titleSpan.className = "codex-entry-title";
          titleSpan.textContent = entry.title || entry.id;

          const metaRow = document.createElement("div");
          metaRow.className = "codex-entry-meta";

          if (entry.category) {
            const catSpan = document.createElement("span");
            catSpan.className = "codex-entry-tag";
            catSpan.textContent = entry.category;
            metaRow.appendChild(catSpan);
          }

          if (entry.tags && entry.tags.length) {
            (entry.tags || []).slice(0, 2).forEach(tag => {
              const tSpan = document.createElement("span");
              tSpan.textContent = tag;
              metaRow.appendChild(tSpan);
            });
          }

          btn.appendChild(titleSpan);
          btn.appendChild(metaRow);

          btn.addEventListener("click", () => {
            activeEntryId = entry.id;
            renderEntryList();
            renderEntryDetail();
            updateUrl(activeEntryId, activeCategory, (searchInput && searchInput.value) || "");
          });

          li.appendChild(btn);
          listEl.appendChild(li);
        });
      }

      function dedupeAppearsIn(arr) {
        if (!Array.isArray(arr)) return [];
        const map = new Map();
        arr.forEach(ref => {
          if (!ref || !ref.bookId) return;
          const key = ref.bookId;
          const pages = ref.page != null ? [ref.page] : (ref.pages || []);
          const existing = map.get(key);
          if (!existing) {
            map.set(key, {
              bookId: ref.bookId,
              bookTitle: ref.bookTitle || ref.bookId,
              pages: pages.filter(p => p != null).map(p => Number(p))
            });
          } else {
            existing.pages.push(...pages.filter(p => p != null).map(p => Number(p)));
          }
        });
        const out = Array.from(map.values());
        out.forEach(o => {
          o.pages = Array.from(new Set(o.pages.map(x => String(x))));
        });
        return out;
      }

      function buildReaderUrlForBookId(bookId, firstPage) {
        const book = booksIndex[bookId] || null;
        if (!book) return null;
        const path = book.path || "";
        if (!path) return null;
        const base = path.replace(/index\.html$/i, "reader.html");
        if (!firstPage) return base;
        return base + "?p=" + encodeURIComponent(firstPage);
      }

      function pickPrimaryBookForEntry(entry) {
        if (!entry || !entry.appearsIn || !entry.appearsIn.length) return null;
        const deduped = dedupeAppearsIn(entry.appearsIn);
        return deduped[0] || null;
      }

      function renderAppearsIn(entry) {
        if (!appearsSectionEl || !appearsBooksEl) return;
        appearsBooksEl.innerHTML = "";

        if (!entry || !entry.appearsIn || !entry.appearsIn.length) {
          appearsSectionEl.style.display = "none";
          return;
        }

        const deduped = dedupeAppearsIn(entry.appearsIn);
        if (!deduped.length) {
          appearsSectionEl.style.display = "none";
          return;
        }

        deduped.forEach(item => {
          const bookId = item.bookId;
          const book = booksIndex[bookId] || null;
          const label = (book && book.title) || bookId;
          const firstPage = item.pages && item.pages.length ? item.pages[0] : null;

          const a = document.createElement("a");
          a.className = "codex-appears-chip";
          const url = buildReaderUrlForBookId(bookId, firstPage);
          a.href = url || "library.html";
          a.target = "_blank";

          const mainSpan = document.createElement("span");
          mainSpan.textContent = label;
          a.appendChild(mainSpan);

          if (item.pages && item.pages.length) {
            const tagSpan = document.createElement("span");
            tagSpan.className = "tagline";
            if (item.pages.length === 1) {
              tagSpan.textContent = "page " + item.pages[0];
            } else {
              tagSpan.textContent = "pages " + item.pages[0] + "â€¦";
            }
            a.appendChild(tagSpan);
          }

          appearsBooksEl.appendChild(a);
        });

        appearsSectionEl.style.display = "";
      }

      function renderEntryDetail() {
        const entry = entries.find(e => e.id === activeEntryId) || null;

        if (!entry) {
          entryIdEl.textContent = "â€“";
          entryTitleEl.textContent = "No entry selected";
          entryChipsEl.innerHTML = "";
          entrySummaryEl.textContent = "Use the index on the left to choose an entry.";
          entryBodyEl.innerHTML = "";
          entryEmptyStateEl.style.display = "none";
          appearsSectionEl.style.display = "none";
          openBookBtn.style.display = "none";
          entryMetaLineEl.textContent = "â€“";
          return;
        }

        entryIdEl.textContent = entry.id || "â€“";
        entryTitleEl.textContent = entry.title || entry.id;

        entryChipsEl.innerHTML = "";
        if (entry.category) {
          const chip = document.createElement("span");
          chip.className = "codex-entry-chip";
          chip.textContent = entry.category;
          entryChipsEl.appendChild(chip);
        }
        if (entry.tags && entry.tags.length) {
          entry.tags.slice(0, 3).forEach(tag => {
            const chip = document.createElement("span");
            chip.className = "codex-entry-chip";
            chip.textContent = tag;
            entryChipsEl.appendChild(chip);
          });
        }

        entrySummaryEl.textContent = entry.summary || "";

        if (entry.body && entry.body.length) {
          entryBodyEl.innerHTML = "";
          (entry.body || []).forEach(block => {
            if (typeof block === "string") {
              const p = document.createElement("p");
              p.textContent = block;
              entryBodyEl.appendChild(p);
            } else if (block && block.heading && block.text) {
              const h = document.createElement("h3");
              h.textContent = block.heading;
              entryBodyEl.appendChild(h);
              const p = document.createElement("p");
              p.textContent = block.text;
              entryBodyEl.appendChild(p);
            }
          });
          entryEmptyStateEl.style.display = "none";
        } else {
          entryBodyEl.innerHTML = "";
          entryEmptyStateEl.style.display = "";
        }

        const catText = entry.category || "Uncategorized";
        const appearsCount = Array.isArray(entry.appearsIn) ? dedupeAppearsIn(entry.appearsIn).length : 0;
        const appearsText = appearsCount ? `Appears in ${appearsCount} work${appearsCount > 1 ? "s" : ""}` : "No linked works";
        entryMetaLineEl.textContent = `${catText} Â· ${appearsText}`;

        renderAppearsIn(entry);

        const mainAppear = pickPrimaryBookForEntry(entry);
        if (mainAppear) {
          const url = buildReaderUrlForBookId(mainAppear.bookId, mainAppear.pages && mainAppear.pages[0]);
          if (url) {
            openBookBtn.href = url;
            openBookBtn.style.display = "";
          } else {
            openBookBtn.style.display = "none";
          }
        } else {
          openBookBtn.style.display = "none";
        }
      }

      function attachEvents() {
        if (searchInput) {
          let searchDebounce = null;
          searchInput.addEventListener("input", () => {
            if (searchDebounce) clearTimeout(searchDebounce);
            searchDebounce = setTimeout(() => {
              updateUrl(activeEntryId, activeCategory, searchInput.value || "");
              renderEntryList();
            }, 130);
          });
        }
      }

      function fetchBooks() {
        return fetch(BOOKS_JSON)
          .then(r => r.json())
          .then(data => {
            booksIndex = {};
            (data || []).forEach(b => {
              if (!b || !b.id) return;
              booksIndex[b.id] = b;
            });
          })
          .catch(err => {
            console.warn("[codex] Failed to load books.json:", err);
          });
      }

      function fetchCodex() {
        return fetch(CODEX_JSON)
          .then(r => r.json())
          .then(data => {
            entries = Array.isArray(data) ? data : [];
            if (countEl) countEl.textContent = entries.length + " entries";
          })
          .catch(err => {
            console.error("[codex] Failed to load Codex:", err);
            entries = [];
            if (countEl) countEl.textContent = "0 entries";
          });
      }

      function boot() {
        const qp = getQueryParams();
        activeCategory = qp.category || "All";

        fetchBooks()
          .then(fetchCodex)
          .then(() => {
            buildCategorySet();
            renderCategories();

            if (searchInput && qp.q) searchInput.value = qp.q;

            if (qp.id && entries.some(e => e.id === qp.id)) {
              activeEntryId = qp.id;
            } else {
              const subset = filteredEntries();
              activeEntryId = subset.length ? subset[0].id : (entries[0] && entries[0].id) || null;
            }

            renderEntryList();
            renderEntryDetail();
            attachEvents();
          });
      }

      boot();
    })();
  </script>
</body>
</html>
